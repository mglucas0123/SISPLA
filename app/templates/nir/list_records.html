{% extends "navbar.html" %}
{% block title %}Registros NIR{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}
    <div class="container-fluid px-4">
        
        {% if stats_counts %}
        {% set counts = stats_counts %}
        {% else %}
        {% set counts = {'total': 0, 'pendentes': 0, 'andamento': 0, 'concluidos': 0} %}
        {% endif %}
        
        <div class="nir-header mb-4">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-4">
                <div class="flex-grow-1">
                    <div class="nir-header-content">
                        <h1 class="mb-2">
                            <i class="bi bi-hospital"></i> 
                            Registros NIR
                            <span class="nir-header-badge">{{ counts.total or 0 }} registros</span>
                        </h1>
                        <p class="mb-0">Registros de Notificação de Internação Regulatória</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="nir-stat-cards">
                {% set active_pendente = filters.sector_progress == 'PENDENTE' %}
                <a
                    href="{% if active_pendente %}{{ url_for('nir.list_records', per_page=request.args.get('per_page')) }}{% else %}{{ url_for('nir.list_records', sector_progress='PENDENTE', per_page=request.args.get('per_page')) }}{% endif %}"
                    class="nir-stat-card nir-stat-card--danger {% if active_pendente %}is-active{% endif %}">
                    <div class="nir-stat-card__icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="nir-stat-card__content">
                        <div class="nir-stat-card__number">{{ counts.pendentes or 0 }}</div>
                        <div class="nir-stat-card__label">Registros Pendentes</div>
                        <div class="nir-stat-card__subtitle">Aguardando processamento</div>
                    </div>
                </a>

                {% set active_andamento = filters.sector_progress == 'EM_ANDAMENTO' %}
                <a
                    href="{% if active_andamento %}{{ url_for('nir.list_records', per_page=request.args.get('per_page')) }}{% else %}{{ url_for('nir.list_records', sector_progress='EM_ANDAMENTO', per_page=request.args.get('per_page')) }}{% endif %}"
                    class="nir-stat-card nir-stat-card--warning {% if active_andamento %}is-active{% endif %}">
                    <div class="nir-stat-card__icon"><i class="bi bi-hourglass-split"></i></div>
                    <div class="nir-stat-card__content">
                        <div class="nir-stat-card__number">{{ counts.andamento or 0 }}</div>
                        <div class="nir-stat-card__label">Em Andamento</div>
                        <div class="nir-stat-card__subtitle">Sendo processados</div>
                    </div>
                </a>

                {% set active_concluido = filters.sector_progress == 'CONCLUIDO' %}
                <a
                    href="{% if active_concluido %}{{ url_for('nir.list_records', per_page=request.args.get('per_page')) }}{% else %}{{ url_for('nir.list_records', sector_progress='CONCLUIDO', per_page=request.args.get('per_page')) }}{% endif %}"
                    class="nir-stat-card nir-stat-card--success {% if active_concluido %}is-active{% endif %}">
                    <div class="nir-stat-card__icon"><i class="bi bi-check2-circle"></i></div>
                    <div class="nir-stat-card__content">
                        <div class="nir-stat-card__number">{{ counts.concluidos or 0 }}</div>
                        <div class="nir-stat-card__label">Registros Concluídos</div>
                        <div class="nir-stat-card__subtitle">Fluxo finalizado</div>
                    </div>
                </a>
            </div>
        </div>

        <div class="nir-filters-modern mb-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-funnel me-2 text-primary"></i>
                    <h5 class="mb-0 text-primary fw-bold">Filtros de Pesquisa</h5>
                </div>
                
                <button type="button" id="exportExcelButton" class="btn btn-export-excel">
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    <span>Exportar para Excel</span>
                </button>
            </div>
            <form method="GET" action="{{ url_for('nir.list_records') }}" id="filtersForm">
                <!-- Primeira Linha de Filtros -->
                <div class="row g-2 mb-2">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold small">Nome do Paciente ou Protocolo</label>
                        <div class="nir-input-with-icon">
                            <i class="bi bi-search icon"></i>
                            <input type="text" id="searchUnified" name="search"
                                   class="form-control form-control-sm" placeholder="Pesquisar..."
                                   value="{{ filters.search or '' }}">
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold small">Data Início</label>
                        <input type="date" id="startDateFilter" name="start_date" class="form-control form-control-sm" value="{{ filters.start_date or '' }}">
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold small">Data Fim</label>
                        <input type="date" id="endDateFilter" name="end_date" class="form-control form-control-sm" value="{{ filters.end_date or '' }}">
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold small">Tipo Entrada</label>
                        <select id="entryTypeFilter" name="entry_type" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for entry_type in entry_types %}
                            <option value="{{ entry_type }}" {{ 'selected' if filters.entry_type == entry_type else '' }}>
                                {{ entry_type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold small">Tipo Internação</label>
                        <select id="admissionTypeFilter" name="admission_type" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for admission_type in admission_types %}
                            <option value="{{ admission_type }}" {{ 'selected' if filters.admission_type == admission_type else '' }}>
                                {{ admission_type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Segunda Linha de Filtros -->
                <div class="row g-2 mb-3">
                    <div class="col-md-2">
                        <label class="form-label fw-semibold small">Paliativo</label>
                        <select id="palliativeFilter" name="is_palliative" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="1" {{ 'selected' if filters.is_palliative == '1' else '' }}>Sim</option>
                            <option value="0" {{ 'selected' if filters.is_palliative == '0' else '' }}>Não</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold small">Local de Origem</label>
                        <select id="originFilter" name="origin" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="Iturama" {{ 'selected' if filters.origin == 'Iturama' else '' }}>Iturama</option>
                            <option value="São Francisco" {{ 'selected' if filters.origin == 'São Francisco' else '' }}>São Francisco</option>
                            <option value="União de Minas" {{ 'selected' if filters.origin == 'União de Minas' else '' }}>União de Minas</option>
                            <option value="Carneirinho" {{ 'selected' if filters.origin == 'Carneirinho' else '' }}>Carneirinho</option>
                            <option value="Limeira do Oeste" {{ 'selected' if filters.origin == 'Limeira do Oeste' else '' }}>Limeira do Oeste</option>
                            <option value="Outro" {{ 'selected' if filters.origin == 'Outro' else '' }}>Outro</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold small">Recurso</label>
                        <select id="recursoFilter" name="recurso" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="PMAE" {{ 'selected' if filters.recurso == 'PMAE' else '' }}>PMAE</option>
                            <option value="PPI" {{ 'selected' if filters.recurso == 'PPI' else '' }}>PPI</option>
                            <option value="Valora Eletivo" {{ 'selected' if filters.recurso == 'Valora Eletivo' else '' }}>Valora Eletivo</option>
                            <option value="Valora Urgencia" {{ 'selected' if filters.recurso == 'Valora Urgencia' else '' }}>Valora Urgencia</option>
                            <option value="Próprio" {{ 'selected' if filters.recurso == 'Próprio' else '' }}>Próprio</option>
                        </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <div class="nir-actions-group w-100">
                            <button type="button" id="applyFiltersButton" class="btn btn-filter">
                                <i class="bi bi-search me-1"></i> Filtrar
                            </button>
                            <button type="button" id="clearFiltersButton" class="btn btn-clear">
                                <i class="bi bi-x-circle me-1"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="recordsTableContainer">
            {% include 'nir/_records_table.html' %}
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function(){
        try {
            const navEntries = performance.getEntriesByType && performance.getEntriesByType('navigation');
            const nav = navEntries && navEntries[0];
            if (nav && nav.type === 'reload') {
                const url = new URL(window.location.href);
                if (url.searchParams.has('sector_progress')) {
                    url.searchParams.delete('sector_progress');
                    url.searchParams.delete('page');
                    window.location.replace(url.toString());
                }
            }
        } catch(e) { }
    })();
    document.addEventListener('DOMContentLoaded', function () {
    const searchUnified = document.getElementById('searchUnified');
        const entryTypeFilter = document.getElementById('entryTypeFilter');
        const admissionTypeFilter = document.getElementById('admissionTypeFilter');
        const palliativeFilter = document.getElementById('palliativeFilter');
        const originFilter = document.getElementById('originFilter');
        const recursoFilter = document.getElementById('recursoFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const perPageSelect = document.getElementById('perPage');

        function filterRecordsWithAjax(customFilters = null, page = 1) {
            const filters = customFilters || {
                search: searchUnified.value.trim(),
                entry_type: entryTypeFilter.value,
                admission_type: admissionTypeFilter.value,
                is_palliative: palliativeFilter.value,
                origin: originFilter.value,
                recurso: recursoFilter.value,
                start_date: startDateFilter.value,
                end_date: endDateFilter.value,
                per_page: perPageSelect ? perPageSelect.value : undefined,
                sector_progress: getSectorProgressFromUrl()
            };

            showLoadingState();

            const params = new URLSearchParams();
            Object.keys(filters).forEach(key => {
                if (filters[key]) params.set(key, filters[key]);
            });
            params.set('page', page);
            if (perPageSelect && perPageSelect.value) {
                params.set('per_page', perPageSelect.value);
            }
            params.set('ajax', '1');

            const url = "{{ url_for('nir.list_records') }}?" + params.toString();

            fetch(url, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    return response.text();
                })
                .then(html => {
                    const currentContainer = document.querySelector('#recordsTableContainer');
                    currentContainer.innerHTML = html;
                    hideLoadingState();
                    currentContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })
                .catch(error => {
                    console.error('Erro ao filtrar registros:', error);
                    hideLoadingState();
                    showErrorMessage('Erro ao carregar os registros. Tente novamente.');
                });
        }

        window.filterRecordsWithAjax = filterRecordsWithAjax;
        window.loadPage = function(pageNum){
            const currentFilters = getCurrentFilters();
            filterRecordsWithAjax(currentFilters, pageNum);
        }

        function getCurrentFilters() {
            return {
                search: searchUnified.value.trim(),
                entry_type: entryTypeFilter.value,
                admission_type: admissionTypeFilter.value,
                start_date: startDateFilter.value,
                end_date: endDateFilter.value,
                per_page: perPageSelect ? perPageSelect.value : undefined,
                sector_progress: getSectorProgressFromUrl()
            };
        }

        function getSectorProgressFromUrl(){
            const params = new URLSearchParams(window.location.search);
            const val = params.get('sector_progress');
            return val && val.trim() !== '' ? val.trim() : undefined;
        }

        function showLoadingState() {
            const tableContainer = document.querySelector('#recordsTableContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'nir-loading';
            loadingDiv.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="padding: 3rem;">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <span class="text-muted">Buscando registros...</span>
                </div>`;
            tableContainer.appendChild(loadingDiv);
        }

        function hideLoadingState() {
            const loadingDiv = document.querySelector('.nir-loading');
            if (loadingDiv) loadingDiv.remove();
        }

        function showErrorMessage(message) {
            const tableContainer = document.querySelector('#recordsTableContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'nir-error alert alert-warning';
            errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${message}`;
            tableContainer.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        let searchTimeout;
        searchUnified.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => filterRecordsWithAjax(), 500);
        });
        searchUnified.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                clearTimeout(searchTimeout);
                filterRecordsWithAjax();
            }
        });
        entryTypeFilter.addEventListener('change', () => filterRecordsWithAjax());
        admissionTypeFilter.addEventListener('change', () => filterRecordsWithAjax());
        palliativeFilter.addEventListener('change', () => filterRecordsWithAjax());
        originFilter.addEventListener('change', () => filterRecordsWithAjax());
        recursoFilter.addEventListener('change', () => filterRecordsWithAjax());
        startDateFilter.addEventListener('change', () => filterRecordsWithAjax());
        endDateFilter.addEventListener('change', () => filterRecordsWithAjax());
        applyFiltersButton.addEventListener('click', () => filterRecordsWithAjax());
        clearFiltersButton.addEventListener('click', () => {
            searchUnified.value = '';
            entryTypeFilter.value = '';
            admissionTypeFilter.value = '';
            palliativeFilter.value = '';
            originFilter.value = '';
            recursoFilter.value = '';
            startDateFilter.value = '';
            endDateFilter.value = '';
            filterRecordsWithAjax();
        });
        if (perPageSelect) {
            perPageSelect.addEventListener('change', () => {
                const currentFilters = getCurrentFilters();
                filterRecordsWithAjax(currentFilters, 1);
            });
        }

        const exportButton = document.getElementById('exportExcelButton');
        if (exportButton) {
            exportButton.addEventListener('click', function() {
                const filters = {
                    search: searchUnified.value.trim(),
                    entry_type: entryTypeFilter.value,
                    admission_type: admissionTypeFilter.value,
                    start_date: startDateFilter.value,
                    end_date: endDateFilter.value,
                    sector_progress: getSectorProgressFromUrl()
                };

                const params = new URLSearchParams();
                Object.keys(filters).forEach(key => {
                    if (filters[key]) {
                        params.set(key, filters[key]);
                    }
                });

                const exportUrl = "{{ url_for('nir.export_to_excel') }}?" + params.toString();
                
                const originalText = exportButton.innerHTML;
                exportButton.disabled = true;
                exportButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando relatório...';

                window.open(exportUrl, '_blank');

                setTimeout(() => {
                    exportButton.disabled = false;
                    exportButton.innerHTML = originalText;
                }, 2000);
            });
        }
    });

    function deleteRecord(recordId) {
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = `/nir/excluir/${recordId}`;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }
</script>
{% endblock %}