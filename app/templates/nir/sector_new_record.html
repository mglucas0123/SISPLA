{% extends "navbar.html" %}
{% block title %}Novo NIR - Setor NIR{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}

    <div class="container">

        <div class="nir-header mb-4">
            <h1>
                <i class="bi bi-plus-circle"></i>
                Criar Novo NIR
            </h1>
            <p>Preencha os dados iniciais de responsabilidade do setor NIR</p>
        </div>

        <div class="card shadow-lg border-0">
            <div class="card-header">
                <h5>
                    <i class="bi bi-pencil-square"></i>
                    Dados de Responsabilidade do NIR
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('nir.create_record') }}">

                    <div class="nir-form-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-person-circle text-danger"></i>
                            Dados do Paciente
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="nir-form-label">Nome do Paciente <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="patient_name" required
                                    placeholder="Nome completo do paciente">
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Data de Nascimento <span
                                        class="text-danger">*</span></label>
                                <input type="date" class="form-control nir-form-control" name="birth_date" required>
                            </div>
                            <div class="col-md-3">
                                <label class="nir-form-label">Sexo <span class="text-danger">*</span></label>
                                <select class="form-select nir-form-control" name="gender" required>
                                    <option value="">Selecione</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="nir-form-label">SUSFacil <span class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="susfacil"
                                    placeholder="Somente números" pattern="[0-9]*" title="Digite apenas números" required>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Cartão SUS <span class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="sus_number" required
                                    placeholder="000 0000 0000 0000" maxlength="18" id="sus-number-input"
                                    title="Formato: 000 0000 0000 0000">
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-clipboard-data text-danger"></i>
                            Dados da Internação
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="nir-form-label">Data de Internação <span class="text-danger">*</span></label>
                                <input type="date" class="form-control nir-form-control" name="admission_date" required>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Tipo de Entrada <span class="text-danger">*</span></label>
                                <select class="form-select nir-form-control" name="entry_type" required>
                                    <option value="">Selecione</option>
                                    <option value="ELETIVO">Eletivo</option>
                                    <option value="URGENCIA">Urgência</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Tipo de Internação <span class="text-danger">*</span></label>
                                <select class="form-select nir-form-control" name="admission_type" required>
                                    <option value="">Selecione</option>
                                    <option value="CLINICO">Clínico</option>
                                    <option value="CIRURGICO">Cirúrgico</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="nir-form-label">Local de Origem <span class="text-danger">*</span></label>
                                <select class="form-select nir-form-control" name="admitted_from_origin" required>
                                    <option value="Iturama">Iturama</option>
                                    <option value="São Francisco">São Francisco</option>
                                    <option value="União de Minas">União de Minas</option>
                                    <option value="Carneirinho">Carneirinho</option>
                                    <option value="Limeira do Oeste">Limeira do Oeste</option>
                                    <option value="Outro">Outro...</option>
                                </select>
                            </div>
                            
                        </div>
                    </div>

                    <div class="nir-form-section mb-4" id="agendamento-inicial-section">
                        <h6 class="section-title">
                            <i class="bi bi-calendar-check text-danger"></i>
                            Agendamento Inicial
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="nir-form-label">Data de Agendamento <span class="text-danger">*</span></label>
                                <input type="date" class="form-control nir-form-control" name="scheduling_date"
                                    id="scheduling-date-initial" required>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('nir.sector_nir_list') }}" class="btn nir-btn-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Voltar
                        </a>
                        <button type="submit" class="btn nir-btn-primary">
                            <i class="bi bi-save"></i>
                            Criar NIR
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const susNumberInput = document.getElementById('sus-number-input');
        const susfacilInput = document.querySelector('input[name="susfacil"]');

        function formatSusNumber(value) {
            const numbers = value.replace(/\D/g, '');
            const limited = numbers.substring(0, 15);
            if (limited.length <= 3) {
                return limited;
            } else if (limited.length <= 7) {
                return limited.substring(0, 3) + ' ' + limited.substring(3);
            } else if (limited.length <= 11) {
                return limited.substring(0, 3) + ' ' + limited.substring(3, 7) + ' ' + limited.substring(7);
            } else {
                return limited.substring(0, 3) + ' ' + limited.substring(3, 7) + ' ' + limited.substring(7, 11) + ' ' + limited.substring(11);
            }
        }

        function validateNumbersOnly(value) {
            return value.replace(/\D/g, '');
        }

        if (susNumberInput) {
            susNumberInput.addEventListener('input', function (e) {
                const formatted = formatSusNumber(e.target.value);
                e.target.value = formatted;
            });
            susNumberInput.addEventListener('keypress', function (e) {
                const char = String.fromCharCode(e.which);
                if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                    e.preventDefault();
                }
            });
        }

        if (susfacilInput) {
            susfacilInput.addEventListener('input', function (e) {
                e.target.value = validateNumbersOnly(e.target.value);
            });
            susfacilInput.addEventListener('keypress', function (e) {
                const char = String.fromCharCode(e.which);
                if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                    e.preventDefault();
                }
            });
        }

    });
</script>
{% endblock %}