{% extends "navbar.html" %}
{% block title %}Detalhes do Registro NIR #{{ record.id }}{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="nir-header">
                        <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                            <h1 class="mb-0 d-flex align-items-center">
                                <i class="bi bi-hospital"></i>
                                Registro NIR #{{ record.id }}
                            </h1>
                            {% if header_wait_label %}
                            <span class="nir-wait-chip {% if header_wait_kind == 'surgery' %}chip-surgery{% elif header_wait_kind == 'billing' %}chip-billing{% endif %} active">
                                <i class="bi {% if header_wait_kind == 'billing' %}bi-cash-stack{% elif header_wait_kind == 'surgery' %}bi-scissors{% elif header_wait_kind == 'done' %}bi-check2-circle{% else %}bi-hourglass-split{% endif %}"></i>
                                {{ header_wait_label }}
                            </span>
                            {% endif %}
                        </div>

                        <div class="mt-3">
                            <a href="{{ url_for('nir.list_records') }}" class="btn nir-btn-secondary me-2">
                                <i class="bi bi-arrow-left me-2"></i>Voltar
                            </a>
                            {% if current_user.has_permission('visualizar_relatorios') %}
                            <a href="{{ url_for('nir.edit_record', record_id=record.id) }}" class="btn btn-warning me-2">
                                <i class="bi bi-pencil me-2"></i>Editar
                            </a>
                            <button class="btn btn-danger" onclick="deleteRecord('{{ record.id }}')">
                                <i class="bi bi-trash me-2"></i>Excluir
                            </button>
                            {% endif %}
                            <button class="btn btn-info" onclick="printRecord()">
                                <i class="bi bi-printer me-2"></i>Imprimir
                            </button>
                        </div>
                    </div>

                    <div class="nir-card card shadow-lg border-0">
                        <div class="card-body">
                            <div class="nir-details-section">
                                <h5>
                                    <i class="bi bi-person-circle"></i>Dados do Paciente
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">Nome do Paciente</label>
                                        <p class="fw-bold">{{ record.patient_name }}</p>
                                    </div>
                                    <div class="col-md-3 nir-detail-item">
                                        <label class="form-label">Data de Nascimento</label>
                                        <p>{{ record.birth_date.strftime('%d/%m/%Y') if record.birth_date else '-' }}</p>
                                    </div>
                                    <div class="col-md-3 nir-detail-item">
                                        <label class="form-label">Sexo</label>
                                        <p>
                                            {% if record.gender == 'M' %}
                                            <span class="nir-badge badge bg-primary">Masculino</span>
                                            {% elif record.gender == 'F' %}
                                            <span class="nir-badge badge bg-danger">Feminino</span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">SUSFacil</label>
                                        <p class="text-monospace">{{ record.susfacil or '-' }}</p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">Número SUS</label>
                                        <p class="text-monospace">{{ record.sus_number or '-' }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="nir-details-section">
                                <h5>
                                    <i class="bi bi-clipboard-data"></i>Dados da Internação
                                </h5>
                                <div class="row">
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Data de Internação</label>
                                        <p class="fw-bold">{{ record.admission_date or '-' | format_date_short }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Tipo de Entrada</label>
                                        <p>
                                            {% if record.entry_type %}
                                            <span class="nir-badge badge bg-{% if record.entry_type == 'URGENCIA' or record.entry_type == 'CIRURGICO' %}danger{% else %}primary{% endif %}">
                                                {{ record.entry_type }}
                                            </span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Tipo de Internação</label>
                                        <p>
                                            {% if record.admission_type %}
                                            <span class="nir-badge badge bg-{% if record.admission_type == 'CIRURGICO' %}warning{% else %}info{% endif %}">
                                                {{ record.admission_type }}
                                            </span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">Local de Origem</label>
                                        <p>
                                            {% if record.admitted_from_origin %}
                                            <span class="nir-badge badge bg-{% if record.admitted_from_origin == 'SIM' %}success{% else %}secondary{% endif %}">
                                                {{ record.admitted_from_origin }}
                                            </span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">AIH</label>
                                        <p class="text-monospace">{{ record.aih or '-' }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="nir-details-section">
                                <h5>
                                    <i class="bi bi-activity"></i>Procedimentos
                                </h5>
                                {% if record.procedures and record.procedures|length > 0 %}
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:1%">#</th>
                                                    <th style="width:12%">Código</th>
                                                    <th>Descrição</th>
                                                    <th style="width:12%">Principal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for p in record.procedures|sort(attribute='sequence') %}
                                                <tr>
                                                    <td class="text-muted small">{{ loop.index }}</td>
                                                    <td class="text-monospace fw-semibold">{{ p.code }}</td>
                                                    <td>{{ p.description }}</td>
                                                    <td>
                                                        {% if p.is_primary %}
                                                            <span class="badge bg-primary">Sim</span>
                                                        {% else %}
                                                            <span class="text-muted small">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="row">
                                        <div class="col-md-4 nir-detail-item">
                                            <label class="form-label">Código do Procedimento (Legado)</label>
                                            <p class="text-monospace">{{ record.procedure_code or '-' }}</p>
                                        </div>
                                        <div class="col-md-8 nir-detail-item">
                                            <label class="form-label">Descrição Cirúrgica (Legado)</label>
                                            <p>{{ record.surgical_description or '-' }}</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="nir-details-section">
                                <h5>
                                    <i class="bi bi-heart-pulse"></i>Informações Médicas
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">Médico Responsável</label>
                                        <p>{{ record.responsible_doctor or '-' }}</p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">CID Principal</label>
                                        <p class="text-monospace">{{ record.main_cid or '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Especialidade Cirúrgica</label>
                                        <p>{{ record.surgical_specialty or '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Auxiliar</label>
                                        <p>{{ record.auxiliary or '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Anestesista</label>
                                        <p>{{ record.anesthetist or '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Anestesia</label>
                                        <p>{{ record.anesthesia or '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Pediatria</label>
                                        <p>{{ record.pediatrics or '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Classificação</label>
                                        <p>
                                            {% if record.surgical_type == 'CONTAMINADA' %}
                                            <span class="nir-badge badge bg-success">Contáminada</span>
                                            {% elif record.surgical_type == 'INFECTADA' %}
                                            <span class="nir-badge badge bg-danger">Infectada</span>
                                            {% elif record.surgical_type == 'LIMPA' %}
                                            <span class="nir-badge badge bg-secondary">Limpa</span>
                                            {% elif record.surgical_type == 'SUSPENSA' %}
                                            <span class="nir-badge badge bg-warning">Suspensa</span>
                                            {% else %}
                                            <span class="nir-badge badge bg-secondary">-</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="nir-details-section">
                                <h5>
                                    <i class="bi bi-calendar-check"></i>Dados de Alta
                                </h5>
                                <div class="row">
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Data de Agendamento</label>
                                        <p>{{ record.scheduling_date.strftime('%d/%m/%Y') if record.scheduling_date else '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Tipo de Alta</label>
                                        <p>
                                            {% if record.discharge_type %}
                                            <span class="nir-badge badge bg-{% if record.discharge_type == 'OBITO' %}dark{% else %}success{% endif %}">
                                                {{ record.discharge_type }}
                                            </span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Data da Alta</label>
                                        <p>{{ record.discharge_date.strftime('%d/%m/%Y') if record.discharge_date else '-' }}</p>
                                    </div>
                                    <div class="col-md-4 nir-detail-item">
                                        <label class="form-label">Total de Dias Internado</label>
                                        <p>
                                            {% if record.total_days_admitted %}
                                            <span class="nir-badge badge bg-info">{{ record.total_days_admitted }} dias</span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="nir-details-section">
                                <h5>
                                    <i class="bi bi-gear"></i>Status e Controle
                                </h5>
                                <div class="row">
                                    <div class="col-md-3 nir-detail-item">
                                        <label class="form-label">Cancelado</label>
                                        <p>
                                            {% if record.cancelled == 'SIM' %}
                                                <span class="nir-badge badge bg-danger">Sim</span>
                                            {% elif record.cancelled in ['NAO','NÃO'] %}
                                                <span class="nir-badge badge bg-success">Não</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    {% if record.cancelled == 'SIM' %}
                                    <div class="col-md-9 nir-detail-item">
                                        <label class="form-label">Motivo do Cancelamento</label>
                                        <p>{{ record.cancellation_reason or '-' }}</p>
                                    </div>
                                    {% endif %}
                                    <div class="col-md-3 nir-detail-item">
                                        <label class="form-label">Criticado</label>
                                        <p>
                                            {% if record.criticized == 'SIM' %}
                                                <span class="nir-badge badge bg-warning text-dark">Sim</span>
                                            {% elif record.criticized == 'NAO' or record.criticized == 'NÃO' %}
                                                <span class="nir-badge badge bg-success">Não</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-3 nir-detail-item">
                                        <label class="form-label">Faturado</label>
                                        <p>
                                            {% if record.billed == 'SIM' %}
                                                <span class="nir-badge badge bg-success">Sim</span>
                                            {% elif record.billed in ['NAO','NÃO'] %}
                                                <span class="nir-badge badge bg-danger">Não</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-3 nir-detail-item">
                                        <label class="form-label">Status</label>
                                        <p>
                                            {% if record.status %}
                                            <span class="nir-badge badge bg-{% if record.status == 'FINALIZADO' %}success{% else %}warning{% endif %}">
                                                {{ record.status }}
                                            </span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-9 nir-detail-item">
                                        <label class="form-label">Observação</label>
                                        <p>{{ record.observation or '-' }}</p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">Operador</label>
                                        <p class="fw-bold">{{ record.operator.name }}</p>
                                    </div>
                                    <div class="col-md-6 nir-detail-item">
                                        <label class="form-label">Data de Criação</label>
                                        <p>{{ record.creation_date | format_date_time }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="deleteForm" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Excluir</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function deleteRecord(recordId) {
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = `/nir/excluir/${recordId}`;

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function printRecord() {
        const printWindow = window.open('', '_blank');
        
        const cardContent = document.querySelector('.nir-card').innerHTML;
        
        const printHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Registro NIR #{{ record.id }}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .nir-details-section { margin-bottom: 20px; page-break-inside: avoid; }
                    .nir-details-section h5 { color: #333; border-bottom: 2px solid #dc3545; padding-bottom: 5px; }
                    .row { display: flex; flex-wrap: wrap; }
                    .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-md-9, .col-12 { flex: 1; min-width: 200px; margin-right: 15px; }
                    .nir-detail-item { margin-bottom: 15px; }
                    .form-label { font-weight: bold; color: #666; font-size: 12px; }
                    .nir-badge { padding: 3px 8px; border-radius: 10px; font-size: 11px; }
                    .bg-primary { background: #007bff !important; color: white; }
                    .bg-success { background: #28a745 !important; color: white; }
                    .bg-danger { background: #dc3545 !important; color: white; }
                    .bg-warning { background: #ffc107 !important; color: black; }
                    .bg-info { background: #17a2b8 !important; color: white; }
                    .bg-secondary { background: #6c757d !important; color: white; }
                    .text-monospace { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <h1>Registro NIR #{{ record.id }}</h1>
                <p><strong>Data de Impressão:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                <hr>
                ${cardContent}
            </body>
            </html>
        `;
        
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
        printWindow.onload = function() {
            printWindow.print();
            printWindow.close();
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}
