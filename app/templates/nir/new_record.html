{% extends "navbar.html" %}
{% block title %}Novo Registro NIR{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}
    <div class="container">
        <div class="nir-header">
            <h1>
                <i class="bi bi-hospital"></i>
                Novo Registro NIR
            </h1>
            <p>Cadastre uma nova Notificação de Internação Regulatória</p>
        </div>

        <div class="nir-card card shadow-lg border-0">
            <div class="card-header">
                <h5>
                    <i class="bi bi-plus-circle"></i>
                    Formulário de Cadastro
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('nir.create_record') }}">
                    <div class="nir-form-section">
                        <h6>
                            <i class="bi bi-person-circle"></i>
                            Dados do Paciente
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="nir-form-label">Nome do Paciente *</label>
                                <input type="text" class="form-control nir-form-control" name="patient_name" required
                                    placeholder="Nome completo do paciente">
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Data de Nascimento *</label>
                                <input type="date" class="form-control nir-form-control" name="birth_date" required>
                            </div>
                            <div class="col-md-3">
                                <label class="nir-form-label">Sexo *</label>
                                <select class="form-select nir-form-control" name="gender" required>
                                    <option value="">Selecione</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="nir-form-label">SUSFacil</label>
                                <input type="text" class="form-control nir-form-control" name="susfacil"
                                    placeholder="Somente números" pattern="[0-9]*" title="Digite apenas números">
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Cartão SUS *</label>
                                <input type="text" class="form-control nir-form-control" name="sus_number" required
                                    placeholder="000 0000 0000 0000" maxlength="18" id="sus-number-input"
                                    title="Formato: 000 0000 0000 0000">
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section">
                        <h6>
                            <i class="bi bi-clipboard-data"></i>
                            Dados da Internação
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="nir-form-label">Data de Internação</label>
                                <input type="date" class="form-control nir-form-control" name="admission_date">
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Tipo de Entrada</label>
                                <select class="form-select nir-form-control" name="entry_type">
                                    <option value="">Selecione</option>
                                    <option value="URGENCIA">Urgência</option>
                                    <option value="ELETIVO">Eletivo</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Tipo de Internação</label>
                                <select class="form-select nir-form-control" name="admission_type">
                                    <option value="">Selecione</option>
                                    <option value="CLINICO">Clínico</option>
                                    <option value="CIRURGICO">Cirúrgico</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="nir-form-label">Local de Origem</label>
                                <select class="form-select nir-form-control" name="admitted_from_origin">
                                    <option value="Iturama" selected>Iturama</option>
                                    <option value="São Francisco">São Francisco</option>
                                    <option value="União de Minas">União de Minas</option>
                                    <option value="Carneirinho">Carneirinho</option>
                                    <option value="Limeira do Oeste">Limeira do Oeste</option>
                                    <option value="Outro">Outro...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="nir-form-label">AIH</label>
                                <input type="text" class="form-control nir-form-control" name="aih"
                                    placeholder="Número da AIH">
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section">
                        <h6>
                            <i class="bi bi-activity"></i>
                            Procedimento
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="nir-form-label">Código do Procedimento</label>
                                <input type="text" class="form-control nir-form-control" name="procedure_code"
                                    placeholder="Código SIGTAP">
                            </div>
                            <div class="col-md-8">
                                <label class="nir-form-label">Descrição Cirúrgica</label>
                                <input type="text" class="form-control nir-form-control" name="surgical_description"
                                    placeholder="Descrição do procedimento">
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section">
                        <h6>
                            <i class="bi bi-heart-pulse"></i>
                            Informações Médicas
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="nir-form-label">Médico Responsável</label>
                                <input type="text" class="form-control nir-form-control" name="responsible_doctor"
                                    placeholder="Nome do médico">
                            </div>
                            <div class="col-md-6">
                                <label class="nir-form-label">CID Principal</label>
                                <input type="text" class="form-control nir-form-control" name="main_cid"
                                    placeholder="CID-10">
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section">
                        <h6>
                            <i class="bi bi-calendar-check"></i>
                            Agendamento e Alta
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="nir-form-label">Data de Agendamento</label>
                                <input type="date" class="form-control nir-form-control" name="scheduling_date">
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Tipo de Alta</label>
                                <select class="form-select nir-form-control" name="discharge_type">
                                    <option value="">Selecione</option>
                                    <option value="ALTA MELHORADA">Alta Melhorada</option>
                                    <option value="ALTA A PEDIDO">Alta a Pedido</option>
                                    <option value="TRANSFERENCIA">Transferência</option>
                                    <option value="OBITO">Óbito</option>
                                    <option value="EVASAO">Evasão</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Data da Alta</label>
                                <input type="date" class="form-control nir-form-control" name="discharge_date">
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section">
                        <h6>
                            <i class="bi bi-gear"></i>
                            Status e Controle
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="nir-form-label">Cancelado</label>
                                <select class="form-select nir-form-control" name="cancelled" id="cancelled-select">
                                    <option value="NAO">Não</option>
                                    <option value="SIM">Sim</option>
                                </select>
                            </div>
                            <div class="col-md-9" id="cancellation-reason-field" style="display: none;">
                                <label class="nir-form-label">Motivo do Cancelamento</label>
                                <input type="text" class="form-control nir-form-control" name="cancellation_reason"
                                    placeholder="Descreva o motivo">
                            </div>
                            <div class="col-md-3">
                                <label class="nir-form-label">Criticado</label>
                                <select class="form-select nir-form-control" name="criticized">
                                    <option value="">Selecione</option>
                                    <option value="SIM">Sim</option>
                                    <option value="NAO">Não</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="nir-form-label">Faturado</label>
                                <select class="form-select nir-form-control" name="billed">
                                    <option value="">Selecione</option>
                                    <option value="SIM">Sim</option>
                                    <option value="NAO">Não</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="nir-form-label">Status</label>
                                <select class="form-select nir-form-control" name="status">
                                    <option value="PENDENTE">Pendente</option>
                                    <option value="FINALIZADO">Finalizado</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="nir-form-label">Observação</label>
                                <textarea class="form-control nir-form-control" name="observation" rows="3"
                                    placeholder="Observações adicionais"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="nir-action-buttons">
                        <a href="{{ url_for('nir.list_records') }}" class="btn nir-btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Voltar
                        </a>
                        <button type="submit" class="btn nir-btn-primary">
                            <i class="bi bi-save me-2"></i>Salvar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cancelledSelect = document.getElementById('cancelled-select');
    const cancellationReasonField = document.getElementById('cancellation-reason-field');
    const cancellationReasonInput = document.querySelector('input[name="cancellation_reason"]');
    const susNumberInput = document.getElementById('sus-number-input');
    const susfacilInput = document.querySelector('input[name="susfacil"]');
    const admissionDateInput = document.querySelector('input[name="admission_date"]');
    const dischargeDateInput = document.querySelector('input[name="discharge_date"]');
    const birthDateInput = document.querySelector('input[name="birth_date"]');
    const form = document.querySelector('form');

    function toggleCancellationReason() {
        if (cancelledSelect.value === 'SIM') {
            cancellationReasonField.style.display = 'block';
            cancellationReasonInput.required = true;
        } else {
            cancellationReasonField.style.display = 'none';
            cancellationReasonInput.required = false;
            cancellationReasonInput.value = '';
        }
    }

    function formatSusNumber(value) {
        const numbers = value.replace(/\D/g, '');
        const limited = numbers.substring(0, 15);
        
        if (limited.length <= 3) {
            return limited;
        } else if (limited.length <= 7) {
            return limited.substring(0, 3) + ' ' + limited.substring(3);
        } else if (limited.length <= 11) {
            return limited.substring(0, 3) + ' ' + limited.substring(3, 7) + ' ' + limited.substring(7);
        } else {
            return limited.substring(0, 3) + ' ' + limited.substring(3, 7) + ' ' + limited.substring(7, 11) + ' ' + limited.substring(11);
        }
    }

    function validateNumbersOnly(value) {
        return value.replace(/\D/g, '');
    }

    function validateDates() {
        const birthDate = birthDateInput.value ? new Date(birthDateInput.value) : null;
        const admissionDate = admissionDateInput.value ? new Date(admissionDateInput.value) : null;
        const dischargeDate = dischargeDateInput.value ? new Date(dischargeDateInput.value) : null;
        const today = new Date();

        if (birthDate && birthDate > today) {
            showValidationError(birthDateInput, 'Data de nascimento não pode ser futura');
            return false;
        }

        if (admissionDate && dischargeDate && dischargeDate <= admissionDate) {
            showValidationError(dischargeDateInput, 'Data de alta deve ser posterior à data de internação');
            return false;
        }

        if (birthDate && admissionDate && admissionDate <= birthDate) {
            showValidationError(admissionDateInput, 'Data de internação deve ser posterior ao nascimento');
            return false;
        }

        clearValidationErrors();
        return true;
    }

    function showValidationError(input, message) {
        clearValidationErrors();
        input.classList.add('is-invalid');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        input.parentNode.appendChild(errorDiv);
    }

    function clearValidationErrors() {
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
    }

    function validateSusNumber(susNumber) {
        const numbers = susNumber.replace(/\D/g, '');
        return numbers.length === 15;
    }

    toggleCancellationReason();
    cancelledSelect.addEventListener('change', toggleCancellationReason);

    if (susNumberInput) {
        susNumberInput.addEventListener('input', function(e) {
            const formatted = formatSusNumber(e.target.value);
            e.target.value = formatted;
            
            if (formatted.replace(/\D/g, '').length > 0 && !validateSusNumber(formatted)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });

        susNumberInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                e.preventDefault();
            }
        });
    }

    if (susfacilInput) {
        susfacilInput.addEventListener('input', function(e) {
            e.target.value = validateNumbersOnly(e.target.value);
        });

        susfacilInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                e.preventDefault();
            }
        });
    }

    [birthDateInput, admissionDateInput, dischargeDateInput].forEach(input => {
        if (input) {
            input.addEventListener('change', validateDates);
        }
    });

    form.addEventListener('submit', function(e) {
        if (!validateDates()) {
            e.preventDefault();
            return false;
        }

        if (susNumberInput && !validateSusNumber(susNumberInput.value)) {
            e.preventDefault();
            showValidationError(susNumberInput, 'Número SUS deve conter 15 dígitos');
            return false;
        }
    });
});
</script>
{% endblock %}