{% extends "navbar.html" %}
{% block title %}NIR - Formulário Centro Cirúrgico{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}
    <div class="container">
        <div class="nir-header">
            <h1>
                <i class="bi bi-scissors"></i>
                Centro Cirúrgico - Formulário Específico
            </h1>
            <p>Preencha as seções de responsabilidade do Centro Cirúrgico</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="alert alert-primary">
                    <h6><i class="bi bi-person-circle"></i> Paciente: {{ record.patient_name }}</h6>
                    <p class="mb-0">SUS: {{ record.sus_number or 'N/I' }} |
                        Entrada: {{ record.entry_type or 'N/D' }}</p>
                </div>
            </div>
        </div>

        <div class="card shadow-lg border-0">
            <div class="card-header">
                <h5>
                    <i class="bi bi-scissors"></i>
                    Seções de Responsabilidade do Centro Cirúrgico
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('nir.update_record', record_id=record.id) }}">

                    <div class="nir-form-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-activity text-danger"></i>
                            Procedimentos
                        </h6>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="nir-form-label">Código</label>
                                <input type="text" class="form-control nir-form-control" id="procedure-code-input"
                                    name="procedure_code" placeholder="Digite código ou parte da descrição" data-procedure-entry>
                                
                            </div>
                            <div class="col-md-6">
                                <label class="nir-form-label">Descrição</label>
                                <input type="text" class="form-control nir-form-control bg-light"
                                    id="surgical-description-input" name="surgical_description" readonly tabindex="-1"
                                    aria-readonly="true">
                            </div>
                            <div class="col-md-2 d-grid">
                                <button class="btn btn-outline-primary mt-2" id="add-procedure-btn" type="button">
                                    <i class="bi bi-plus-circle"></i> Adicionar
                                </button>
                            </div>
                            <div class="col-12">
                                <div class="border rounded p-2 bg-body-tertiary" id="procedures-list"
                                    aria-live="polite" data-can-edit-procedures="1">
                                    {% for procedure in record.procedures %}
                                    <input type="hidden" name="procedure_codes[]" value="{{ procedure.code }}">
                                    <input type="hidden" name="procedure_descriptions[]"
                                        value="{{ procedure.description }}">
                                    {% endfor %}
                                </div>
                                <small class="text-muted">Adicione/remova procedimentos. O primeiro será considerado principal.</small>
                            </div>
                        </div>
                    </div>

                    <div class="nir-form-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-heart-pulse text-danger"></i>
                            Informações Médicas
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="nir-form-label">Médico Responsável <span class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="responsible_doctor"
                                    value="{{ record.responsible_doctor or '' }}" placeholder="Nome do médico" required>
                            </div>
                            <div class="col-md-6">
                                <label class="nir-form-label">CID Principal <span class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="main_cid"
                                    value="{{ record.main_cid or '' }}" placeholder="Ex: A00.0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Especialidade Cirúrgica <span class="text-danger">*</span></label>
                                <select class="form-select nir-form-control" name="surgical_specialty" required>
                                    <option value="">Selecione</option>
                                    <option value="CIRURGIA GERAL" {% if record.surgical_specialty=='CIRURGIA GERAL'
                                        %}selected{% endif %}>Cirurgia Geral</option>
                                    <option value="CLINICO GERAL" {% if record.surgical_specialty=='CLINICO GERAL'
                                        %}selected{% endif %}>Clínico Geral</option>
                                    <option value="DENTISTA" {% if record.surgical_specialty=='DENTISTA' %}selected{%
                                        endif %}>Dentista</option>
                                    <option value="DERMATO" {% if record.surgical_specialty=='DERMATO' %}selected{%
                                        endif %}>Dermatologia</option>
                                    <option value="OBSTETRICIA" {% if record.surgical_specialty=='OBSTETRICIA'
                                        %}selected{% endif %}>Obstetrícia</option>
                                    <option value="OFTALMOLOGISTA" {% if record.surgical_specialty=='OFTALMOLOGISTA'
                                        %}selected{% endif %}>Oftalmologia</option>
                                    <option value="ORTOPEDISTA" {% if record.surgical_specialty=='ORTOPEDISTA'
                                        %}selected{% endif %}>Ortopedia</option>
                                    <option value="UROLOGISTA" {% if record.surgical_specialty=='UROLOGISTA'
                                        %}selected{% endif %}>Urologia</option>
                                    <option value="VASCULAR" {% if record.surgical_specialty=='VASCULAR' %}selected{%
                                        endif %}>Vascular</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Classificação <span class="text-danger">*</span></label>
                                <select class="form-select nir-form-control" name="surgical_type" required>
                                    <option value="">Selecione</option>
                                    <option value="CONTAMINADA" {% if record.surgical_type=='CONTAMINADA' %}selected{%
                                        endif %}>Contaminada</option>
                                    <option value="INFECTADA" {% if record.surgical_type=='INFECTADA' %}selected{% endif
                                        %}>Infectada</option>
                                    <option value="LIMPA" {% if record.surgical_type=='LIMPA' %}selected{% endif %}>
                                        Limpa</option>
                                    <option value="SUSPENSA" {% if record.surgical_type=='SUSPENSA' %}selected{% endif
                                        %}>Suspensa</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label d-flex align-items-center justify-content-between">Médico
                                    Auxiliar
                                    <span class="form-check form-check-inline m-0">
                                        <input class="form-check-input" type="checkbox" id="aux-nao-aplica"
                                            name="auxiliary_nao_aplica" value="1" {% if not record.auxiliary %} {% endif
                                            %}>
                                        <label class="form-check-label small" for="aux-nao-aplica">Não se aplica</label>
                                    </span>
                                </label>
                                <input type="text" class="form-control nir-form-control" name="auxiliary"
                                    id="auxiliary-input" value="{{ record.auxiliary or '' }}"
                                    placeholder="Nome do auxiliar" required>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Anestesista <span class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="anesthetist"
                                    value="{{ record.anesthetist or '' }}" placeholder="Nome do anestesista" required>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Anestesia <span class="text-danger">*</span></label>
                                <input type="text" class="form-control nir-form-control" name="anesthesia"
                                    value="{{ record.anesthesia or '' }}" placeholder="Tipo de anestesia" required>
                            </div>
                            <div class="col-md-12">
                                <label
                                    class="nir-form-label d-flex align-items-center justify-content-between">Pediatria
                                    <span class="form-check form-check-inline m-0">
                                        <input class="form-check-input" type="checkbox" id="ped-nao-aplica"
                                            name="pediatrics_nao_aplica" value="1" {% if not record.pediatrics %} {%
                                            endif %}>
                                        <label class="form-check-label small" for="ped-nao-aplica">Não se aplica</label>
                                    </span>
                                </label>
                                <input type="text" class="form-control nir-form-control" name="pediatrics"
                                    id="pediatrics-input" value="{{ record.pediatrics or '' }}"
                                    placeholder="Nome do Pediatra" required>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-4">
                        <a href="{{ url_for('nir.sector_surgery_list') }}" class="btn btn-outline-secondary"
                            id="btn-voltar-lista">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                        <div>
                            <button type="submit" class="btn btn-danger btn-lg text-dark">
                                <i class="bi bi-check-circle"></i> Salvar e Marcar como Concluído
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='nir/nir_procedures.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        function toggleField(cbId, inputId) {
            const cb = document.getElementById(cbId);
            const input = document.getElementById(inputId);
            if (!cb || !input) return;
            const applyState = () => {
                if (cb.checked) {
                    input.value = '';
                    input.disabled = true;
                    input.classList.add('bg-light');
                } else {
                    input.disabled = false;
                    input.classList.remove('bg-light');
                }
            };
            cb.addEventListener('change', applyState);
            applyState();
        }
        toggleField('aux-nao-aplica', 'auxiliary-input');
        toggleField('ped-nao-aplica', 'pediatrics-input');

    });
</script>
{% endblock %}

<style>
    .section-title {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}