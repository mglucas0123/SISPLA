{% extends "navbar.html" %}
{% block title %}NIR - Formulário Faturamento{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}
    <div class="container">
        <div class="nir-header">
            <h1>
                <i class="bi bi-receipt"></i>
                Faturamento - Formulário Específico
            </h1>
            <p>Finalize o registro com informações de controle e status</p>
        </div>

        {% set progress = record.get_sector_progress() %}

        <div class="card mb-4" style="background-color: #f8f9fa;">
            <div class="card-header">
                <h6><i class="bi bi-file-text"></i> Resumo do Registro</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Paciente:</strong><br>
                        {{ record.patient_name }}
                    </div>
                    <div class="col-md-3">
                        <strong>Data de Internação:</strong><br>
                        {{ record.admission_date.strftime('%d/%m/%Y') if record.admission_date else 'N/I' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Tipo de Entrada:</strong><br>
                        <span
                            class="badge {% if record.entry_type == 'ELETIVO' %}bg-primary{% elif record.entry_type == 'URGENCIA' %}bg-danger text-white{% endif %}">
                            {{ record.entry_type or 'N/D' }}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <strong>Médico Responsável:</strong><br>
                        {{ record.responsible_doctor or 'N/I' }}
                    </div>
                    <div class="col-md-3">
                        <strong>CID Principal:</strong><br>
                        {{ record.main_cid or 'N/I' }}
                    </div>
                </div>
                {% if record.procedures %}
                <hr>
                <div class="row">
                    <div class="col-12">
                        <strong>Procedimentos:</strong><br>
                        <ul class="mb-0">
                            {% for procedure in record.procedures %}
                            <li>{{ procedure.code }} - {{ procedure.description }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-lg border-0">
            <div class="card-header">
                <h5>
                    <i class="bi bi-receipt"></i>
                    Finalização - Status e Controle
                </h5>
                <small class="text-muted">Última etapa do processo</small>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('nir.update_record', record_id=record.id) }}">

                    <div class="nir-form-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-clipboard-check text-danger"></i>
                            Status e Controle
                        </h6>

                        <div class="row g-3">
                            <div class="col-12" id="cancellation-reason-group" style="display: none;">
                                <label class="nir-form-label">Motivo do Cancelamento</label>
                                <textarea class="form-control nir-form-control" name="cancellation_reason" id="cancellation-reason" rows="2"
                                    placeholder="Descreva o motivo do cancelamento">{{ record.cancellation_reason or '' }}</textarea>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="nir-form-label">Criticado?</label>
                                <select class="form-select nir-form-control" name="criticized" id="criticized-select" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="NAO">Não</option>
                                    <option value="SIM">Sim</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Faturado?</label>
                                <select class="form-select nir-form-control" name="billed" id="billed-select" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="NAO">Não</option>
                                    <option value="SIM">Sim</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="nir-form-label">Status Final</label>
                                <select class="form-select nir-form-control" name="status" id="final-status-select" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="CONCLUIDO">Concluído</option>
                                    <option value="CANCELADO">Cancelado</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <label class="nir-form-label">Observações Finais</label>
                                <textarea class="form-control nir-form-control" name="observation" rows="4"
                                    placeholder="Observações adicionais sobre o registro...">{{ record.observation or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-4">
                        <a href="{{ url_for('nir.sector_billing_list') }}" class="btn btn-outline-secondary"
                            id="btn-voltar-lista">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                        <div>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check2-all"></i> Finalizar Registro
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const reasonGroup = document.getElementById('cancellation-reason-group');
    const reasonField = document.getElementById('cancellation-reason');
    const finalStatusSelect = document.getElementById('final-status-select');
    const billedSelect = document.getElementById('billed-select');
    const criticizedSelect = document.getElementById('criticized-select');

    function updateReasonVisibility() {
        const isCancelled = finalStatusSelect && finalStatusSelect.value === 'CANCELADO';
        reasonGroup.style.display = isCancelled ? 'block' : 'none';
        if (reasonField) {
            if (isCancelled) {
                reasonField.setAttribute('required', 'required');
            } else {
                reasonField.removeAttribute('required');
            }
        }
    }

    function updateConstraints() {
        const isCriticizedSim = criticizedSelect && criticizedSelect.value === 'SIM';
        if (billedSelect) {
            const billedSimOption = Array.from(billedSelect.options).find(o => o.value === 'SIM');
            if (billedSimOption) billedSimOption.disabled = isCriticizedSim;
            if (isCriticizedSim && billedSelect.value === 'SIM') {
                billedSelect.value = '';
            }
        }
        if (finalStatusSelect && isCriticizedSim && finalStatusSelect.value === 'CONCLUIDO') {
            finalStatusSelect.value = '';
        }
        updateReasonVisibility();
    }

    function syncFromFinalStatus() {
        if (!finalStatusSelect) return;
        if (finalStatusSelect.value === 'CONCLUIDO' && billedSelect) {
            const isCriticizedSim = criticizedSelect && criticizedSelect.value === 'SIM';
            if (isCriticizedSim) {
                finalStatusSelect.value = '';
            } else {
                billedSelect.value = 'SIM';
            }
        }
        updateReasonVisibility();
    }

    function syncFromBilled() {
        if (!finalStatusSelect || !billedSelect) return;
        if (finalStatusSelect.value === 'CONCLUIDO' && billedSelect.value !== 'SIM') {
            finalStatusSelect.value = 'CANCELADO';
        }
        updateReasonVisibility();
    }

    if (finalStatusSelect) {
        finalStatusSelect.addEventListener('change', syncFromFinalStatus);
    }
    if (billedSelect) {
        billedSelect.addEventListener('change', syncFromBilled);
    }
    if (criticizedSelect) {
        criticizedSelect.addEventListener('change', updateConstraints);
    }

    updateConstraints();
</script>

<style>
    .section-title {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}