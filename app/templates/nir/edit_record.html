{% extends "navbar.html" %}
{% block title %}Editar Registro NIR #{{ record.id }}{% endblock %}

{% block content %}
<div class="nir-container">
    {% include 'partials/_flash_messages.html' %}
        <div class="container">
            <div class="nir-header">
                <h1>
                    <i class="bi bi-hospital"></i>
                    Editar Registro NIR
                </h1>
                <p>Atualize as informações do registro #{{ record.id }}</p>
            </div>

            <div class="nir-card card shadow-lg border-0">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-pencil-square"></i>
                        Formulário de Edição
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('nir.update_record', record_id=record.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="nir-form-section">
                            <h6>
                                <i class="bi bi-person-circle"></i>
                                Dados do Paciente
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="nir-form-label">Nome do Paciente <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control nir-form-control" name="patient_name" value="{{ record.patient_name }}" placeholder="Nome completo do paciente">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Data de Nascimento <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control nir-form-control" name="birth_date" value="{{ record.birth_date.strftime('%Y-%m-%d') if record.birth_date else '' }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="nir-form-label">Sexo <span class="text-danger">*</span></label>
                                    <select class="form-select nir-form-control" name="gender">
                                        <option value="">Selecione</option>
                                        <option value="M" {% if record.gender == 'M' %}selected{% endif %}>Masculino</option>
                                        <option value="F" {% if record.gender == 'F' %}selected{% endif %}>Feminino</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="nir-form-label">SUSFacil</label>
                                    <input type="text" class="form-control nir-form-control" name="susfacil" value="{{ record.susfacil or '' }}" 
                                        placeholder="Somente números" pattern="[0-9]*" title="Digite apenas números">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Cartão SUS <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control nir-form-control" name="sus_number" value="{{ record.sus_number or '' }}"
                                        placeholder="000 0000 0000 0000" maxlength="18" id="sus-number-input"
                                        title="Formato: 000 0000 0000 0000">
                                </div>
                            </div>
                        </div>

                        <div class="nir-form-section">
                            <h6>
                                <i class="bi bi-clipboard-data"></i>
                                Dados da Internação
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="nir-form-label">Data de Internação</label>
                                    <input type="date" class="form-control nir-form-control" name="admission_date" value="{{ record.admission_date.strftime('%Y-%m-%d') if record.admission_date else '' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Tipo de Entrada</label>
                                    <select class="form-select nir-form-control" name="entry_type">
                                        <option value="">Selecione</option>
                                        <option value="URGENCIA" {% if record.entry_type == 'URGENCIA' %}selected{% endif %}>Urgência</option>
                                        <option value="ELETIVO" {% if record.entry_type == 'ELETIVO' %}selected{% endif %}>Eletivo</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Tipo de Internação</label>
                                    <select class="form-select nir-form-control" name="admission_type" id="admission_type_edit">
                                        <option value="">Selecione</option>
                                        <option value="CLINICO" {% if record.admission_type == 'CLINICO' %}selected{% endif %}>Clínico</option>
                                        <option value="CIRURGICO" {% if record.admission_type == 'CIRURGICO' %}selected{% endif %}>Cirúrgico</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="nir-form-label">Local de Origem</label>
                                    <select class="form-select nir-form-control" name="admitted_from_origin">
                                        <option value="Iturama" {% if record.admitted_from_origin == 'Iturama' or not record.admitted_from_origin %}selected{% endif %}>Iturama</option>
                                        <option value="São Francisco" {% if record.admitted_from_origin == 'São Francisco' %}selected{% endif %}>São Francisco</option>
                                        <option value="União de Minas" {% if record.admitted_from_origin == 'União de Minas' %}selected{% endif %}>União de Minas</option>
                                        <option value="Carneirinho" {% if record.admitted_from_origin == 'Carneirinho' %}selected{% endif %}>Carneirinho</option>
                                        <option value="Limeira do Oeste" {% if record.admitted_from_origin == 'Limeira do Oeste' %}selected{% endif %}>Limeira do Oeste</option>
                                        <option value="Outro" {% if record.admitted_from_origin == 'Outro' %}selected{% endif %}>Outro...</option>
                                    </select>
                                </div>
                                <div class="col-md-12" id="palliative-field-edit" style="display: {% if record.admission_type == 'CLINICO' %}block{% else %}none{% endif %};">
                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" id="is_palliative_edit" name="is_palliative" {% if record.is_palliative %}checked{% endif %}>
                                        <label class="form-check-label fw-bold text-danger" for="is_palliative_edit">
                                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                            Paciente Paliativo
                                        </label>
                                    </div>
                                    <small class="form-text text-muted ms-4">
                                        Marque esta opção para pacientes em cuidados paliativos (somente para internações clínicas)
                                    </small>
                                </div>
                                <div class="col-md-12">
                                    <label class="nir-form-label">AIH</label>
                                    <input type="text" class="form-control nir-form-control" name="aih" value="{{ record.aih or '' }}" placeholder="Número da AIH">
                                </div>
                            </div>
                        </div>

                        <div class="nir-form-section">
                            <h6>
                                <i class="bi bi-activity"></i>
                                Procedimentos
                            </h6>
                            {% set can_edit_procedures = editable_sections.get('procedimentos', False) %}
                            <div class="row g-3 align-items-end">
                                {% if can_edit_procedures %}
                                <div class="col-md-4">
                                    <label class="nir-form-label">Código</label>
                                    <input type="text" class="form-control nir-form-control" name="procedure_code" id="procedure-code-input" value="" placeholder="Digite código ou parte da descrição">
                                </div>
                                <div class="col-md-6">
                                    <label class="nir-form-label">Descrição</label>
                                    <input type="text" class="form-control nir-form-control bg-light" name="surgical_description" id="surgical-description-input" value="" readonly tabindex="-1" aria-readonly="true">
                                </div>
                                <div class="col-md-2 d-grid">
                                    <button class="btn btn-outline-primary mt-2" id="add-procedure-btn" type="button">
                                        <i class="bi bi-plus-circle"></i> Adicionar
                                    </button>
                                </div>
                                {% else %}
                                <div class="col-12">
                                    <div class="alert alert-info py-2" role="alert">
                                        Esta seção é editável apenas pelo setor Centro Cirúrgico. Você pode visualizar os procedimentos abaixo.
                                    </div>
                                </div>
                                {% endif %}
                                <div class="col-12">
                                    <div class="border rounded p-2 bg-body-tertiary" id="procedures-list" aria-live="polite" data-can-edit-procedures="{{ '1' if can_edit_procedures else '0' }}">
                                        {% for p in record.procedures %}
                                            <div class="d-flex align-items-start gap-2 mb-1">
                                                <div class="flex-grow-1 small border rounded p-2 bg-white">
                                                    <strong>{{ p.code }}</strong><br>
                                                    <span class="text-muted">{{ p.description }}</span>
                                                </div>
                                                {% if can_edit_procedures %}
                                                <button type="button" class="btn btn-sm btn-outline-danger" aria-label="Remover" data-index="{{ loop.index0 }}">&times;</button>
                                                {% endif %}
                                                <input type="hidden" name="procedure_codes[]" value="{{ p.code }}">
                                                <input type="hidden" name="procedure_descriptions[]" value="{{ p.description }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if can_edit_procedures %}
                                    <small class="text-muted">Adicione/remova procedimentos. O primeiro será considerado principal.</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="nir-form-section">
                            <h6>
                                <i class="bi bi-heart-pulse"></i>
                                Informações Médicas
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="nir-form-label">Médico Responsável</label>
                                    <input type="text" class="form-control nir-form-control" name="responsible_doctor" value="{{ record.responsible_doctor or '' }}" placeholder="Nome do médico">
                                </div>
                                <div class="col-md-6">
                                    <label class="nir-form-label">CID Principal</label>
                                    <select class="form-select nir-form-control" id="main-cid-select" name="main_cid">
                                        <option value="">Selecione um procedimento primeiro</option>
                                        {% if record.main_cid %}
                                        <option value="{{ record.main_cid }}" selected>{{ record.main_cid }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Especialidade Cirúrgica</label>
                                    <select class="form-select nir-form-control" name="surgical_specialty">
                                        <option value="">Selecione</option>
                                        {% set spec = record.surgical_specialty or '' %}
                                        {% set labels = {
                                            'CIRURGIA GERAL':'Cirurgia Geral',
                                            'CLINICO GERAL':'Clínico Geral',
                                            'DENTISTA':'Dentista',
                                            'DERMATO':'Dermatologia',
                                            'OBSTETRICIA':'Obstetrícia',
                                            'OFTALMOLOGISTA':'Oftalmologia',
                                            'ORTOPEDISTA':'Ortopedia',
                                            'UROLOGISTA':'Urologia',
                                            'VASCULAR':'Vascular'
                                        } %}
                                        {% for opt, label in labels.items() %}
                                        <option value="{{ opt }}" {% if spec == opt %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Auxiliar</label>
                                    <input type="text" class="form-control nir-form-control" name="auxiliary" value="{{ record.auxiliary or '' }}" placeholder="Nome do auxiliar">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Anestesista</label>
                                    <input type="text" class="form-control nir-form-control" name="anesthetist" value="{{ record.anesthetist or '' }}" placeholder="Nome do anestesista">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Anestesia</label>
                                    <input type="text" class="form-control nir-form-control" name="anesthesia" value="{{ record.anesthesia or '' }}" placeholder="Tipo de anestesia">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Pediatria</label>
                                    <input type="text" class="form-control nir-form-control" name="pediatrics" value="{{ record.pediatrics or '' }}" placeholder="Nome do Pediatra (se aplicável)">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Classificação</label>
                                    {% set stype = record.surgical_type or '' %}
                                    <select class="form-select nir-form-control" name="surgical_type">
                                        <option value="">Selecione</option>
                                        {% set type_labels = {
                                            'CONTAMINADA':'Contaminada',
                                            'INFECTADA':'Infectada',
                                            'LIMPA':'Limpa',
                                            'SUSPENSA':'Suspensa'
                                        } %}
                                        {% for opt, label in type_labels.items() %}
                                        <option value="{{ opt }}" {% if stype == opt %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="nir-form-section">
                            <h6>
                                <i class="bi bi-calendar-check"></i>
                                Dados de Alta
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="nir-form-label">Data de Agendamento</label>
                                    <input type="date" class="form-control nir-form-control" name="scheduling_date" value="{{ record.scheduling_date.strftime('%Y-%m-%d') if record.scheduling_date else '' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Tipo de Alta</label>
                                    <select class="form-select nir-form-control" name="discharge_type">
                                        <option value="">Selecione</option>
                                        <option value="ALTA MELHORADA" {% if record.discharge_type == 'ALTA MELHORADA' %}selected{% endif %}>Alta Melhorada</option>
                                        <option value="TRANSFERENCIA" {% if record.discharge_type == 'TRANSFERENCIA' %}selected{% endif %}>Transferência</option>
                                        <option value="OBITO" {% if record.discharge_type == 'OBITO' %}selected{% endif %}>Óbito</option>
                                        <option value="EVASAO" {% if record.discharge_type == 'EVASAO' %}selected{% endif %}>Evasão</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="nir-form-label">Data da Alta</label>
                                    <input type="date" class="form-control nir-form-control" name="discharge_date" value="{{ record.discharge_date.strftime('%Y-%m-%d') if record.discharge_date else '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="nir-form-section">
                            <h6>
                                <i class="bi bi-gear"></i>
                                Status e Controle
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="nir-form-label">Cancelado</label>
                                    <select class="form-select nir-form-control" name="cancelled" id="cancelledSelect">
                                        <option value="NAO" {% if record.cancelled == 'NAO' or not record.cancelled %}selected{% endif %}>Não</option>
                                        <option value="SIM" {% if record.cancelled == 'SIM' %}selected{% endif %}>Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-9" id="cancellationReasonDiv" {% if record.cancelled != 'SIM' %}style="display: none;"{% endif %}>
                                    <label class="nir-form-label">Motivo do Cancelamento</label>
                                    <input type="text" class="form-control nir-form-control" name="cancellation_reason" value="{{ record.cancellation_reason or '' }}" placeholder="Descreva o motivo do cancelamento">
                                </div>
                                <div class="col-md-3">
                                    <label class="nir-form-label">Criticado</label>
                                    <select class="form-select nir-form-control" name="criticized">
                                        <option value="">Selecione</option>
                                        <option value="SIM" {% if record.criticized == 'SIM' %}selected{% endif %}>Sim</option>
                                        <option value="NAO" {% if record.criticized == 'NAO' %}selected{% endif %}>Não</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="nir-form-label">Faturado</label>
                                    <select class="form-select nir-form-control" name="billed">
                                        <option value="SIM" {% if record.billed == 'SIM' %}selected{% endif %}>Sim</option>
                                        <option value="NAO" {% if record.billed == 'NAO' %}selected{% endif %}>Não</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="nir-form-label">Status</label>
                                    <select class="form-select nir-form-control" name="status">
                                        <option value="PENDENTE" {% if record.status == 'PENDENTE' or not record.status %}selected{% endif %}>Pendente</option>
                                        <option value="EM_ANDAMENTO" {% if record.status == 'EM_ANDAMENTO' %}selected{% endif %}>Em Andamento</option>
                                        <option value="CONCLUIDO" {% if record.status == 'CONCLUIDO' %}selected{% endif %}>Concluído</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="nir-form-label">Recurso <span class="text-danger">*</span></label>
                                    <select class="form-select nir-form-control" name="recurso" required>
                                        <option value="">Selecione o recurso</option>
                                        <option value="PMAE" {% if record.recurso == 'PMAE' %}selected{% endif %}>PMAE</option>
                                        <option value="PPI" {% if record.recurso == 'PPI' %}selected{% endif %}>PPI</option>
                                        <option value="Valora Eletivo" {% if record.recurso == 'Valora Eletivo' %}selected{% endif %}>Valora Eletivo</option>
                                        <option value="Valora Urgencia" {% if record.recurso == 'Valora Urgencia' %}selected{% endif %}>Valora Urgencia</option>
                                        <option value="Próprio" {% if record.recurso == 'Próprio' %}selected{% endif %}>Próprio</option>
                                    </select>
                                    <small class="text-muted">Campo de responsabilidade do Faturamento</small>
                                </div>
                                <div class="col-12">
                                    <label class="nir-form-label">Observação</label>
                                    <textarea class="form-control nir-form-control" name="observation" rows="3" placeholder="Observações adicionais">{{ record.observation or '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <div class="nir-action-buttons">
                            <a href="{{ url_for('nir.record_details', record_id=record.id) }}" class="btn nir-btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn nir-btn-primary">
                                <i class="bi bi-save me-2"></i>Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cancelledSelect = document.getElementById('cancelledSelect');
        const cancellationReasonDiv = document.getElementById('cancellationReasonDiv');
        const cancellationReasonInput = cancellationReasonDiv.querySelector('input[name="cancellation_reason"]');
        const susNumberInput = document.getElementById('sus-number-input');
        const susfacilInput = document.querySelector('input[name="susfacil"]');
        
        function toggleCancellationReason() {
            if (cancelledSelect.value === 'SIM') {
                cancellationReasonDiv.style.display = 'block';
            } else {
                cancellationReasonDiv.style.display = 'none';
                cancellationReasonInput.value = '';
            }
        }

        function formatSusNumber(value) {
            const numbers = value.replace(/\D/g, '');
            
            const limited = numbers.substring(0, 15);
            
            if (limited.length <= 3) {
                return limited;
            } else if (limited.length <= 7) {
                return limited.substring(0, 3) + ' ' + limited.substring(3);
            } else if (limited.length <= 11) {
                return limited.substring(0, 3) + ' ' + limited.substring(3, 7) + ' ' + limited.substring(7);
            } else {
                return limited.substring(0, 3) + ' ' + limited.substring(3, 7) + ' ' + limited.substring(7, 11) + ' ' + limited.substring(11);
            }
        }

        function validateNumbersOnly(value) {
            return value.replace(/\D/g, '');
        }

        cancelledSelect.addEventListener('change', toggleCancellationReason);
        toggleCancellationReason();

        if (susNumberInput) {
            susNumberInput.value = formatSusNumber(susNumberInput.value);

            susNumberInput.addEventListener('input', function(e) {
                const formatted = formatSusNumber(e.target.value);
                e.target.value = formatted;
            });

            susNumberInput.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                    e.preventDefault();
                }
            });
        }

        if (susfacilInput) {
            susfacilInput.addEventListener('input', function(e) {
                e.target.value = validateNumbersOnly(e.target.value);
            });

            susfacilInput.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                    e.preventDefault();
                }
            });
        }

        const admissionTypeEditSelect = document.getElementById('admission_type_edit');
        const palliativeFieldEdit = document.getElementById('palliative-field-edit');
        const palliativeCheckboxEdit = document.getElementById('is_palliative_edit');

        if (admissionTypeEditSelect && palliativeFieldEdit) {
            admissionTypeEditSelect.addEventListener('change', function() {
                if (this.value === 'CLINICO') {
                    palliativeFieldEdit.style.display = 'block';
                } else {
                    palliativeFieldEdit.style.display = 'none';
                    if (palliativeCheckboxEdit) {
                        palliativeCheckboxEdit.checked = false;
                    }
                }
            });
        }

        function updateCidOptions() {
            const proceduresContainer = document.getElementById('procedures-container');
            const cidSelect = document.getElementById('main-cid-select');
            
            if (!proceduresContainer || !cidSelect) return;
            
            const firstProcedureInput = proceduresContainer.querySelector('input[name="procedure_codes[]"]');
            
            if (!firstProcedureInput || !firstProcedureInput.value.trim()) {
                cidSelect.innerHTML = '<option value="">Selecione um procedimento primeiro</option>';
                cidSelect.disabled = true;
                return;
            }
            
            const procedureCode = firstProcedureInput.value.trim();
            const currentCid = cidSelect.value;
            
            fetch(`/nir/procedure/${encodeURIComponent(procedureCode)}/cids`)
                .then(response => response.json())
                .then(cids => {
                    if (cids.length === 0) {
                        cidSelect.innerHTML = '<option value="">Nenhum CID compatível encontrado</option>';
                        cidSelect.disabled = true;
                    } else {
                        cidSelect.disabled = false;
                        const escapeHtml = (str) => {
                            const div = document.createElement('div');
                            div.textContent = str || '';
                            return div.innerHTML;
                        };
                        cidSelect.innerHTML = '<option value="">Selecione o CID</option>' +
                            cids.map(cid => 
                                `<option value="${escapeHtml(cid.code)}" ${cid.code === currentCid ? 'selected' : ''}>
                                    ${escapeHtml(cid.code)} - ${escapeHtml(cid.description)}
                                </option>`
                            ).join('');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar CIDs:', error);
                    cidSelect.innerHTML = '<option value="">Erro ao carregar CIDs</option>';
                    cidSelect.disabled = true;
                });
        }

        const procedureInputs = document.querySelectorAll('#procedures-container input[name="procedure_codes[]"]');
        if (procedureInputs.length > 0 && procedureInputs[0].value.trim()) {
            updateCidOptions();
        }

        window.updateCidOptions = updateCidOptions;
    });
</script>
<script src="{{ url_for('static', filename='nir/nir_procedures.js') }}"></script>
{% endblock %}