{% extends "navbar.html" %}
{% block title %}Gerenciar Mural de Avisos{% endblock %}

{% block content %}
<div class="manage-notices-page">
    <div class="container">
        {% include 'partials/_flash_messages.html' %}

        <div class="manage-notices-header">
            <div class="manage-notices-header-content">
                <div class="manage-notices-title-section">
                    <h1 class="manage-notices-main-title">
                        <i class="bi bi-megaphone-fill"></i>
                        Gerenciar Mural de Avisos
                    </h1>
                    <p class="manage-notices-subtitle">
                        Publique e gerencie avisos importantes do sistema
                    </p>
                </div>
                <div class="manage-notices-actions">
                    <button class="manage-notices-create-btn" data-bs-toggle="modal" data-bs-target="#criarAvisoModal">
                        <i class="bi bi-plus-circle"></i>
                        Novo Aviso
                    </button>
                    <a href="{{ url_for('main.panel') }}" class="manage-notices-back-btn">
                        <i class="bi bi-arrow-left-circle"></i>
                        Voltar ao Painel
                    </a>
                </div>
            </div>
        </div>

        <div class="manage-notices-section">
            <div class="manage-notices-table-container">
                {% if notices %}
                <table class="manage-notices-table table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>
                                <i class="bi bi-card-text me-2"></i>
                                Aviso
                            </th>
                            <th style="width: 20%; text-align: center;">
                                <i class="bi bi-calendar3 me-2"></i>
                                Data
                            </th>
                            <th style="width: 20%; text-align: center;">
                                <i class="bi bi-person-circle me-2"></i>
                                Autor
                            </th>
                            <th style="width: 15%; text-align: center;">
                                <i class="bi bi-gear me-2"></i>
                                Ações
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for notice in notices %}
                        <tr class="notice-row">
                            <td class="notice-content-cell">
                                <div class="notice-info-container">
                                    <div class="notice-icon">
                                        {% if notice.notice_type == 'IMAGE' %}
                                        <i class="bi bi-image"></i>
                                        {% else %}
                                        <i class="bi bi-card-text"></i>
                                        {% endif %}
                                    </div>
                                    <div class="notice-details">
                                        {% if notice.notice_type == 'IMAGE' and notice.image_filename %}
                                        <p class="notice-title">Aviso em Imagem</p>
                                        <small class="notice-preview">Clique para visualizar imagem</small>
                                        {% else %}
                                        <p class="notice-title">{{ notice.title[:50] }}{% if notice.title|length > 50 %}...{% endif %}</p>
                                        <small class="notice-preview">{{ notice.content[:80] }}{% if notice.content|length > 80 %}...{% endif %}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="notice-date-cell">
                                <span class="notice-date">{{ notice.date_registry.strftime('%d/%m/%Y') }}</span>
                                <small class="notice-time">{{ notice.date_registry.strftime('%H:%M') }}</small>
                            </td>
                            <td class="notice-author-cell">
                                <span class="notice-author">{{ notice.author.name }}</span>
                            </td>
                            <td class="notice-actions-cell">
                                <button class="notice-view-btn" data-bs-toggle="modal" data-bs-target="#visualizarAvisoModal"
                                        data-notice-id="{{ notice.id }}"
                                        data-notice-type="{{ notice.notice_type }}"
                                        data-notice-title="{{ notice.title | default('Aviso em Imagem') }}"
                                        data-notice-content="{{ notice.content | default('') }}"
                                        data-notice-image="{{ notice.image_filename if notice.image_filename else '' }}"
                                        data-notice-author="{{ notice.author.name }}"
                                        data-notice-date="{{ notice.date_registry | format_date_time }}">
                                    <i class="bi bi-eye-fill"></i>
                                    Ver
                                </button>
                                <form method="POST" action="{{ url_for('admin.notices.delete_notice', notice_id=notice.id) }}" 
                                      onsubmit="return confirm('Tem certeza que deseja excluir este aviso?');" class="notice-delete-form" style="display: inline;">
                                    <button type="submit" class="notice-delete-btn" title="Deletar Aviso">
                                        <i class="bi bi-trash3-fill"></i>
                                        Excluir
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="manage-notices-empty">
                    <div class="manage-notices-empty-icon">
                        <i class="bi bi-megaphone"></i>
                    </div>
                    <h3 class="manage-notices-empty-title">Nenhum aviso encontrado</h3>
                    <p class="manage-notices-empty-text">Comece publicando o primeiro aviso para seus usuários.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="criarAvisoModal" tabindex="-1" aria-labelledby="criarAvisoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="criarAvisoModalLabel">
                    <i class="bi bi-plus-circle-fill"></i>
                    Publicar Novo Aviso
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="manage-notices-tabs">
                    <nav class="manage-notices-nav">
                        <button class="manage-notices-tab-btn active" data-tab="text">
                            <i class="bi bi-card-text"></i>
                            <span>Aviso em Texto</span>
                        </button>
                        <button class="manage-notices-tab-btn" data-tab="image">
                            <i class="bi bi-card-image"></i>
                            <span>Aviso com Imagem</span>
                        </button>
                    </nav>
                </div>

                <div class="manage-notices-forms">
                    <div class="manage-notices-form-container active" id="text-form">
                        <form method="POST" action="{{ url_for('admin.notices.manage_notices') }}" class="manage-notices-form">
                            <input type="hidden" name="notice_type" value="TEXT">

                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    <i class="bi bi-type"></i>
                                    Título do Aviso
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" name="title" id="title" 
                                       placeholder="Digite um título chamativo para o aviso" required>
                            </div>

                            <div class="mb-3">
                                <label for="content" class="form-label">
                                    <i class="bi bi-card-text"></i>
                                    Conteúdo do Aviso
                                    <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" name="content" id="content" 
                                          rows="6" placeholder="Digite o conteúdo detalhado do aviso..." required></textarea>
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-send-fill"></i>
                                Publicar Aviso em Texto
                            </button>
                        </form>
                    </div>

                    <div class="manage-notices-form-container" id="image-form">
                        <form method="POST" action="{{ url_for('admin.notices.manage_notices') }}" 
                              enctype="multipart/form-data" class="manage-notices-form">
                            <input type="hidden" name="notice_type" value="IMAGE">

                            <div class="mb-3">
                                <label for="image_file" class="form-label">
                                    <i class="bi bi-image"></i>
                                    Selecionar Imagem
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="manage-notices-file-input-container">
                                    <input class="form-control" type="file" name="image_file" 
                                           id="image_file" accept="image/jpeg, image/png, image/gif" required>
                                </div>
                                <div class="form-text">
                                    Formatos aceitos: JPEG, PNG, GIF (máximo 5MB)
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-image"></i>
                                Publicar Aviso com Imagem
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="visualizarAvisoModal" tabindex="-1" aria-labelledby="visualizarAvisoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visualizarAvisoModalLabel">
                    <i class="bi bi-eye"></i>
                    Visualizar Aviso
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="avisoContent">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabBtns = document.querySelectorAll('.manage-notices-tab-btn');
    const formContainers = document.querySelectorAll('.manage-notices-form-container');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');

            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            formContainers.forEach(container => {
                container.classList.remove('active');
                if (container.id === targetTab + '-form') {
                    container.classList.add('active');
                }
            });
        });
    });

    var visualizarAvisoModal = document.getElementById('visualizarAvisoModal');
    var avisoContent = document.getElementById('avisoContent');

    visualizarAvisoModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var noticeType = button.getAttribute('data-notice-type');
        var noticeTitle = button.getAttribute('data-notice-title');
        var noticeContent = button.getAttribute('data-notice-content');
        var noticeImage = button.getAttribute('data-notice-image');
        var noticeAuthor = button.getAttribute('data-notice-author');
        var noticeDate = button.getAttribute('data-notice-date');

        var content = '';

        if (noticeType === 'IMAGE' && noticeImage) {
            content = `
                <div class="text-center mb-3">
                    <img src="{{ url_for('admin.notices.serve_notice_image', filename='') }}${noticeImage}" 
                         class="img-fluid rounded" alt="Aviso em imagem" style="max-height: 400px;">
                </div>
            `;
        } else {
            content = `
                <h4 class="mb-3">${noticeTitle}</h4>
                <div class="notice-content" style="white-space: pre-wrap; line-height: 1.6;">
                    ${noticeContent}
                </div>
            `;
        }

        content += `
            <hr>
            <div class="d-flex justify-content-between text-muted">
                <small><i class="bi bi-person-circle me-1"></i> ${noticeAuthor}</small>
                <small><i class="bi bi-calendar3 me-1"></i> ${noticeDate}</small>
            </div>
        `;

        avisoContent.innerHTML = content;
    });
});
</script>
{% endblock %}