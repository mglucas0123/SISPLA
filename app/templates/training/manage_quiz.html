{% extends "navbar.html" %}
{% block title %}Editor de Avaliação: {{ course.title }}{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="manage-quiz-page">
    <div class="container">
        {% include 'partials/_flash_messages.html' %}
        <div class="manage-quiz-header">
            <div class="manage-quiz-header-content">
                <div class="manage-quiz-title-section">
                    <h1 class="manage-quiz-main-title">
                        <i class="bi bi-ui-checks-grid"></i>
                        Editor de Avaliação
                    </h1>
                    <p class="manage-quiz-subtitle">
                        Configure questões e material de apoio para seu curso
                    </p>
                    <div class="manage-quiz-course-name">
                        <i class="bi bi-camera-reels me-2"></i>{{ course.title }}
                    </div>
                </div>
                <div class="manage-quiz-actions">
                    <a href="{{ url_for('admin.courses.manage_courses') }}" class="manage-quiz-back-btn">
                        <i class="bi bi-arrow-left"></i>
                        Voltar
                    </a>
                    <button type="submit" form="quizForm" class="manage-quiz-save-btn">
                        <i class="bi bi-check-circle-fill"></i>
                        Salvar Avaliação
                    </button>
                </div>
            </div>
        </div>

        <form method="POST" id="quizForm" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="questions_data" id="questions_data_input">

            <div class="manage-quiz-basic-info">
                <div class="manage-quiz-section-header">
                    <h5 class="manage-quiz-section-title">
                        <i class="bi bi-info-circle"></i>
                        Informações Básicas
                    </h5>
                </div>
                <div class="manage-quiz-section-content">
                    <div class="mb-3">
                        <label for="quiz_title" class="form-label">Título da Avaliação</label>
                        <input type="text" class="form-control" id="quiz_title" name="quiz_title" 
                               value="{% if quiz %}{{ quiz.title }}{% else %}Avaliação - {{ course.title }}{% endif %}" 
                               placeholder="Digite o título da avaliação..." required>
                    </div>
                </div>
            </div>

            <div class="manage-quiz-support-section">
                <div class="manage-quiz-section-header">
                    <h5 class="manage-quiz-section-title">
                        <i class="bi bi-paperclip"></i>
                        Texto e Material de Apoio
                    </h5>
                </div>
                <div class="manage-quiz-section-content">
                    <div class="manage-quiz-text-editor">
                        <label for="support_text_editor" class="form-label">Texto Principal da Avaliação</label>
                        <textarea id="support_text_editor" name="support_text" class="form-control">{{ quiz.support_text or '' }}</textarea>
                    </div>

                    <div class="manage-quiz-attachments">
                        <h6 class="manage-quiz-attachments-title">Materiais Anexados</h6>
                        <ul id="attachment-list" class="manage-quiz-attachment-list list-group">
                            {% if quiz %}
                            {% for attachment in quiz.attachments %}
                            <li class="list-group-item" data-attachment-id="{{ attachment.id }}">
                                <div class="attachment-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <a href="{{ url_for('training.download_attachment', attachment_id=attachment.id) }}" target="_blank">{{ attachment.filename }}</a>
                                </div>
                                <button type="button" class="delete-attachment-btn" title="Excluir anexo">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </li>
                            {% endfor %}
                            {% endif %}
                        </ul>

                        <div class="manage-quiz-file-upload">
                            <label for="file-input" class="form-label">Adicionar Novos Materiais</label>
                            {% if not quiz %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                Salve a avaliação primeiro para poder adicionar materiais de apoio.
                            </div>
                            {% endif %}
                            <input class="form-control" type="file" id="file-input" multiple 
                                   {% if not quiz %}disabled{% endif %}>
                            <div class="form-text">Você pode selecionar múltiplos arquivos. Eles serão enviados automaticamente.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="manage-quiz-questions-section">
                <div class="manage-quiz-questions-header">
                    <h5 class="manage-quiz-questions-title">
                        <i class="bi bi-question-circle"></i>
                        Questões da Avaliação
                    </h5>
                    <button type="button" id="addQuestionBtn" class="manage-quiz-add-question-btn">
                        <i class="bi bi-plus-lg"></i>
                        Adicionar Nova Questão
                    </button>
                </div>
                <div class="manage-quiz-questions-content">
                    <div id="questions-container" class="manage-quiz-questions-container">
                        {% if not quiz.questions %}
                        <div class="manage-quiz-empty-state">
                            <div class="manage-quiz-empty-icon">
                                <i class="bi bi-question-circle-fill"></i>
                            </div>
                            <h6 class="manage-quiz-empty-title">Nenhuma questão adicionada</h6>
                            <p class="manage-quiz-empty-text">
                                Clique no botão "Adicionar Nova Questão" para começar a criar sua avaliação.
                            </p>
                        </div>
                        {% else %}
                        {% for q in quiz.questions | sort(attribute='id') %}
                        <div class="manage-quiz-question-card question-card" data-question-id="{{ q.id }}">
                            <div class="manage-quiz-question-header grab-handle">
                                <span class="manage-quiz-question-number">
                                    <i class="bi bi-grip-vertical grip-handle"></i>
                                    Questão {{ loop.index }}
                                </span>
                                <button type="button" class="remove-question-btn" aria-label="Remover Questão">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <div class="manage-quiz-question-content">
                                <div class="manage-quiz-question-input">
                                    <label class="form-label">Texto da Questão</label>
                                    <textarea class="form-control question-text" rows="3" placeholder="Digite o enunciado da questão...">{{ q.text }}</textarea>
                                </div>
                                <div class="manage-quiz-question-type">
                                    <label class="form-label">Tipo de Questão</label>
                                    <select class="form-select question-type">
                                        <option value="MULTIPLE_CHOICE" {% if q.question_type=='MULTIPLE_CHOICE' %}selected{% endif %}>Múltipla Escolha</option>
                                        <option value="TEXT_INPUT" {% if q.question_type=='TEXT_INPUT' %}selected{% endif %}>Resposta de Texto</option>
                                    </select>
                                </div>
                                <div class="manage-quiz-options-container options-container">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Templates -->
<template id="question-template">
    <div class="manage-quiz-question-card question-card" data-question-id="">
        <div class="manage-quiz-question-header grab-handle">
            <span class="manage-quiz-question-number">
                <i class="bi bi-grip-vertical grip-handle"></i>
                Nova Questão
            </span>
            <button type="button" class="remove-question-btn">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="manage-quiz-question-content">
            <div class="manage-quiz-question-input">
                <label class="form-label">Texto da Questão</label>
                <textarea class="form-control question-text" rows="3" placeholder="Digite o enunciado da questão..."></textarea>
            </div>
            <div class="manage-quiz-question-type">
                <label class="form-label">Tipo de Questão</label>
                <select class="form-select question-type">
                    <option value="MULTIPLE_CHOICE" selected>Múltipla Escolha</option>
                    <option value="TEXT_INPUT">Resposta de Texto</option>
                </select>
            </div>
            <div class="manage-quiz-options-container options-container"></div>
        </div>
    </div>
</template>

<template id="multiple-choice-options-template">
    <h6 class="manage-quiz-options-title">Opções de Resposta (marque a correta):</h6>
    <div class="manage-quiz-options-list options-list"></div>
    <button type="button" class="manage-quiz-add-option-btn add-option-btn">
        <i class="bi bi-plus-circle"></i>
        Adicionar Opção
    </button>
</template>

<template id="multiple-choice-option-item-template">
    <div class="manage-quiz-option-item">
        <input class="form-check-input option-radio" type="radio">
        <input type="text" class="form-control option-text" placeholder="Texto da opção...">
        <button type="button" class="remove-option-btn" aria-label="Remover Opção">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</template>

<template id="text-input-answer-template">
    <h6 class="manage-quiz-options-title">Resposta Correta:</h6>
    <div class="manage-quiz-text-answer">
        <input type="text" class="form-control option-text" placeholder="Digite a resposta exata esperada...">
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ super() }}

<script src="https://cdn.tiny.cloud/1/b4pqlx299weaeap6l3vesk9o2upzittw60sza0j94vxdewc2/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

<script>
    tinymce.init({
        selector: 'textarea#support_text_editor',
        plugins: 'code lists link image table help wordcount',
        toolbar: 'undo redo | blocks | ' +
            'bold italic underline | bullist numlist | ' +
            'link image | code | help',
        height: 300,
        menubar: false,
        language: 'pt_BR',
        skin: 'oxide',
        content_css: 'default'
    });

    document.addEventListener('DOMContentLoaded', function () {
        const questionsContainer = document.getElementById('questions-container');
        const quizForm = document.getElementById('quizForm');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        const initialQuizData = {% if quiz %}JSON.parse('{{ quiz.to_dict() | tojson | safe }}'){% else %}null{% endif %};
        const attachmentList = document.getElementById('attachment-list');
        const fileInput = document.getElementById('file-input');
        const quizId = {% if quiz %}'{{ quiz.id }}'{% else %}null{% endif %};

        function toggleEmptyState() {
            const emptyState = document.querySelector('.manage-quiz-empty-state');
            const hasQuestions = questionsContainer.querySelectorAll('.manage-quiz-question-card').length > 0;

            if (emptyState) {
                emptyState.style.display = hasQuestions ? 'none' : 'block';
            }
        }

        function updateAttachmentUploadState() {
            const fileInputSection = document.querySelector('.manage-quiz-file-upload');
            if (!quizId) {
                fileInput.disabled = true;
                fileInputSection.style.opacity = '0.5';
                fileInputSection.title = 'Salve o quiz primeiro para adicionar anexos';
            } else {
                fileInput.disabled = false;
                fileInputSection.style.opacity = '1';
                fileInputSection.title = '';
            }
        }

        function renderQuestion(questionData) {
            const card = questionsContainer.querySelector(`[data-question-id="${questionData.id}"]`);
            if (!card) return;
            const optionsContainer = card.querySelector('.options-container');
            updateOptionsUI(optionsContainer, questionData.question_type, questionData.options, questionData.id);
        }

        function updateOptionsUI(container, type, options = [], questionId = '') {
            container.innerHTML = '';
            if (type === 'MULTIPLE_CHOICE') {
                const mcTemplate = document.getElementById('multiple-choice-options-template').content.cloneNode(true);
                const optionsList = mcTemplate.querySelector('.options-list');
                options.forEach(opt => {
                    const itemTemplate = document.getElementById('multiple-choice-option-item-template').content.cloneNode(true);
                    itemTemplate.querySelector('.option-text').value = opt.text;
                    const radio = itemTemplate.querySelector('input[type="radio"]');
                    radio.name = `correct_option_${questionId}`;
                    radio.checked = opt.is_correct;
                    optionsList.appendChild(itemTemplate);
                });
                container.appendChild(mcTemplate);
            } else if (type === 'TEXT_INPUT') {
                const tiTemplate = document.getElementById('text-input-answer-template').content.cloneNode(true);
                tiTemplate.querySelector('.option-text').value = options.length > 0 ? options[0].text : '';
                container.appendChild(tiTemplate);
            }
        }

        function updateQuestionNumbers() {
            document.querySelectorAll('.manage-quiz-question-card').forEach((card, index) => {
                const numberSpan = card.querySelector('.manage-quiz-question-number');
                const gripHandle = numberSpan.querySelector('.grip-handle');
                const gripHTML = gripHandle ? gripHandle.outerHTML : '<i class="bi bi-grip-vertical grip-handle"></i>';
                numberSpan.innerHTML = gripHTML + ` Questão ${index + 1}`;
            });
        }

        function addQuestion() {
            const template = document.getElementById('question-template');
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.manage-quiz-question-card');
            const uniqueId = `new_${Date.now()}`;
            card.dataset.questionId = uniqueId;
            questionsContainer.appendChild(clone);

            const newCardElement = questionsContainer.querySelector(`[data-question-id="${uniqueId}"]`);
            const select = newCardElement.querySelector('.question-type');
            updateOptionsUI(newCardElement.querySelector('.options-container'), select.value, [], uniqueId);
            updateQuestionNumbers();
            toggleEmptyState();
        }

        function prepareAndSubmit(event) {
            event.preventDefault();
            tinymce.triggerSave();
            let questionsData = [];
            let isValid = true;

            document.querySelectorAll('.manage-quiz-question-card').forEach(card => {
                const questionText = card.querySelector('.question-text').value;
                const questionType = card.querySelector('.question-type').value;
                let options = [];

                if (!questionText.trim()) {
                    alert('Atenção: Uma questão está sem o texto do enunciado.');
                    isValid = false;
                    return;
                }

                if (questionType === 'MULTIPLE_CHOICE') {
                    let hasCorrect = false;
                    card.querySelectorAll('.manage-quiz-option-item').forEach(optGroup => {
                        const text = optGroup.querySelector('.option-text').value.trim();
                        const isCorrect = optGroup.querySelector('input[type="radio"]').checked;
                        if (isCorrect) hasCorrect = true;
                        if (text) options.push({ text, is_correct: isCorrect });
                    });
                    if (!hasCorrect && options.length > 0) {
                        alert('Atenção: Uma questão de múltipla escolha não tem resposta correta marcada.');
                        isValid = false;
                        return;
                    }
                } else if (questionType === 'TEXT_INPUT') {
                    const answerText = card.querySelector('.option-text').value.trim();
                    if (answerText) {
                        options.push({ text: answerText, is_correct: true });
                    } else {
                        alert('Atenção: Uma questão de texto não tem resposta definida.');
                        isValid = false;
                        return;
                    }
                }

                questionsData.push({
                    id: card.dataset.questionId,
                    text: questionText,
                    question_type: questionType,
                    options: options
                });
            });

            if (!isValid) return;

            document.getElementById('questions_data_input').value = JSON.stringify(questionsData);
            quizForm.submit();
        }

        attachmentList.addEventListener('click', function (e) {
            const deleteBtn = e.target.closest('.delete-attachment-btn');
            if (!deleteBtn) return;

            const listItem = deleteBtn.closest('li');
            const attachmentId = listItem.dataset.attachmentId;

            if (confirm('Tem certeza que deseja excluir este anexo permanentemente?')) {
                fetch(`{{ url_for('admin.quiz.delete_quiz_attachment', attachment_id=0) }}`.replace('/0/', `/${attachmentId}/`), {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        listItem.remove();
                    } else {
                        alert('Erro ao excluir: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });

        fileInput.addEventListener('change', function (e) {
            const files = e.target.files;
            if (files.length === 0) return;
            
            // Verificar se existe um quiz antes de tentar fazer upload
            if (!quizId) {
                alert('Você precisa salvar o quiz primeiro antes de adicionar anexos.');
                return;
            }

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                fetch(`{{ url_for('admin.quiz.upload_quiz_attachment', quiz_id=0) }}`.replace('/0/', `/${quizId}/`), {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Resposta não é JSON válido');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const newAttachment = data.attachment;
                        const newListItem = document.createElement('li');
                        newListItem.className = 'list-group-item';
                        newListItem.dataset.attachmentId = newAttachment.id;
                        newListItem.innerHTML = `
                            <div class="attachment-info">
                                <i class="bi bi-file-earmark-text"></i>
                                <a href="${newAttachment.url}" target="_blank">${newAttachment.filename}</a>
                            </div>
                            <button type="button" class="delete-attachment-btn" title="Excluir anexo">
                                <i class="bi bi-trash"></i>
                            </button>`;
                        attachmentList.appendChild(newListItem);
                    } else {
                        alert(`Erro no upload de "${file.name}": ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error uploading file:', error);
                    alert(`Ocorreu um erro de rede ao enviar "${file.name}".`);
                });
            }
            e.target.value = '';
        });

        if (initialQuizData && initialQuizData.questions) {
            initialQuizData.questions.forEach(renderQuestion);
        }

        // Atualizar estado do upload de anexos
        updateAttachmentUploadState();

        questionsContainer.addEventListener('click', function (e) {
            if (e.target.closest('.remove-question-btn')) {
                if (confirm('Tem certeza que deseja remover esta questão?')) {
                    e.target.closest('.manage-quiz-question-card').remove();
                    updateQuestionNumbers();
                    toggleEmptyState();
                }
            } else if (e.target.closest('.add-option-btn')) {
                const questionCard = e.target.closest('.manage-quiz-question-card');
                const optionsList = questionCard.querySelector('.manage-quiz-options-list');
                const itemTemplate = document.getElementById('multiple-choice-option-item-template').content.cloneNode(true);
                itemTemplate.querySelector('input[type="radio"]').name = `correct_option_${questionCard.dataset.questionId}`;
                optionsList.appendChild(itemTemplate);
            } else if (e.target.closest('.remove-option-btn')) {
                if (confirm('Remover esta opção?')) {
                    e.target.closest('.manage-quiz-option-item').remove();
                }
            }
        });

        questionsContainer.addEventListener('change', function (e) {
            if (e.target.classList.contains('question-type')) {
                const card = e.target.closest('.manage-quiz-question-card');
                updateOptionsUI(card.querySelector('.options-container'), e.target.value, [], card.dataset.questionId);
            }
        });

        addQuestionBtn.addEventListener('click', addQuestion);
        quizForm.addEventListener('submit', prepareAndSubmit);

        toggleEmptyState();
        updateQuestionNumbers();
    });
</script>
{% endblock %}