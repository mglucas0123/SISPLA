
{% extends "navbar.html" %}
{% block title %}{{ course.title }}{% endblock %}

{% block styles %}
{{ super() }}
<style>

    .course-pdf-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .course-pdf-actions .course-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        border-radius: 999px;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
    }

    .course-pdf-actions .course-btn-outline {
        background: transparent;
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .course-pdf-actions .course-btn-outline:hover {
        background: rgba(226, 232, 240, 0.95);
        color: #0f172a;
        border-color: transparent;
    }

    .course-pdf-frame {
        width: 100%;
        height: 90vh;
        border-radius: 14px;
        overflow: hidden;
        background: #050b1a;
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.35);
        box-sizing: border-box;
    }

    .course-pdf-frame iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="course-page">
    <div class="container py-4">
        {% include 'partials/_flash_messages.html' %}
        
        <div class="course-player-container">
            {% set content_type = course.content_type or "video" %}
            {% set is_pdf = (content_type == "pdf") %}
            {% set has_quiz = quiz and quiz.questions|length > 0 %}
            <div class="course-player-header">
                <div class="course-player-breadcrumb">
                    <a href="{{ url_for('training.course_list_page') }}" class="course-breadcrumb-link">
                        <i class="bi bi-arrow-left"></i>
                        Voltar aos Cursos
                    </a>
                </div>
                <div class="course-player-info">
                    <h1 class="course-player-title">{{ course.title }}</h1>
                    <p class="course-player-description">{{ course.description }}</p>
                    <div class="course-player-meta">
                        <div class="course-meta-item">
                            <i class="bi bi-clock"></i>
                            <span>{{ (course.duration_seconds / 60)|round|int }} min</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="bi bi-mortarboard"></i>
                            <span>Curso Técnico</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="course-content-wrapper" class="course-video-card">
                <div class="course-video-header">
                    <div class="course-video-title">
                        <i class="bi {{ 'bi-file-earmark-pdf-fill' if is_pdf else 'bi-play-circle-fill' }}"></i>
                        {{ 'Conteúdo em PDF' if is_pdf else 'Vídeo Principal' }}
                    </div>
                    <div class="course-video-status">
                        {% if is_completed %}
                            <span class="course-status-badge course-status-completed">
                                <i class="bi bi-check-circle-fill"></i>
                                Concluído
                            </span>
                        {% else %}
                            <span class="course-status-badge course-status-progress">
                                <i class="bi {{ 'bi-file-earmark-medical' if is_pdf else 'bi-play-circle' }}"></i>
                                {{ 'Disponível' if is_pdf else 'Em Progresso' }}
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="course-video-container">
                    {% if is_pdf %}
                        <div class="course-pdf-frame">
                            <iframe class="course-pdf-viewer" src="{{ url_for('training.serve_video', course_id=course.id) }}#toolbar=0&navpanes=0&scrollbar=0&view=FitH" title="Visualizador de PDF do curso"></iframe>
                        </div>
                    {% else %}
                    <video id="course-video" class="course-video" controls controlsList="nodownload">
                        <source src="{{ url_for('training.serve_video', course_id=course.id) }}" type="video/mp4">
                        <div class="course-video-error">
                            <div class="course-error-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <p>Seu navegador não suporta o player de vídeo.</p>
                        </div>
                    </video>
                    {% endif %}
                </div>
            </div>
            <div id="quiz-container" class="course-quiz-card" {% if not is_completed and content_type == "video" %}style="display: none;"{% endif %}>
                <div class="course-quiz-header">
                    <div class="course-quiz-title">
                        <i class="bi bi-patch-question-fill"></i>
                        Avaliação do Curso
                    </div>
                </div>
                <div class="course-quiz-body">
                    {% if quiz and quiz.questions|length > 0 %}
                        {% if quiz.support_text or quiz.attachments %}
                        <div class="course-support-materials">
                            <div class="course-support-header">
                                <h5 class="course-support-title">
                                    <i class="bi bi-file-earmark-text"></i>
                                    Material de Apoio
                                </h5>
                            </div>
                            
                            {% if quiz.support_text %}
                            <div class="course-support-text">
                                {{ quiz.support_text | safe }}
                            </div>
                            {% endif %}
                            
                            {% if quiz.attachments %}
                            <div class="course-attachments">
                                <h6 class="course-attachments-title">Arquivos para Download:</h6>
                                <div class="course-attachments-grid">
                                    {% for attachment in quiz.attachments %}
                                    <a href="{{ url_for('training.download_attachment', attachment_id=attachment.id) }}" 
                                       target="_blank" class="course-attachment-item">
                                        <div class="course-attachment-icon">
                                            <i class="bi bi-file-earmark-arrow-down"></i>
                                        </div>
                                        <div class="course-attachment-info">
                                            <span class="course-attachment-name">{{ attachment.filename }}</span>
                                            <span class="course-attachment-action">Baixar arquivo</span>
                                        </div>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if is_completed and user_attempt %}
                        <div class="course-quiz-results">
                            <div class="course-results-header">
                                <h5 class="course-results-title">
                                    <i class="bi bi-clipboard-check"></i>
                                    Suas Respostas
                                </h5>
                                {% if user_attempt.score is not none %}
                                <div class="course-results-score">
                                    <span class="course-score-label">Nota Final:</span>
                                    <span class="course-score-value">{{ "%.0f"|format(user_attempt.score) }}%</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <form class="course-quiz-form course-quiz-review">
                                {% for question in quiz.questions | sort(attribute='id') %}
                                <div class="course-question-item course-question-answered">
                                    <div class="course-question-header">
                                        <span class="course-question-number">{{ loop.index }}</span>
                                        <p class="course-question-text">{{ question.text }}</p>
                                    </div>
                                    
                                    {% set user_answer_data = user_attempt.answers_dict.get(question.id|string) %}
                                    
                                    {% if question.question_type.name == 'MULTIPLE_CHOICE' %}
                                    <div class="course-question-options">
                                        {% for option in question.options %}
                                        <div class="course-option-item {% if user_answer_data and option.id == user_answer_data.answer %}course-option-selected{% endif %} {% if option.is_correct %}course-option-correct-answer{% endif %}">
                                            <div class="course-option-content">
                                                <input class="course-option-input" type="radio" name="question_{{ question.id }}" 
                                                       value="{{ option.id }}" id="option_{{ option.id }}" disabled 
                                                       {% if user_answer_data and option.id == user_answer_data.answer %}checked{% endif %}>
                                                <label class="course-option-label" for="option_{{ option.id }}">
                                                    {{ option.text }}
                                                </label>
                                            </div>
                                            <div class="course-option-feedback">
                                                {% if user_answer_data and option.id == user_answer_data.answer %}
                                                    {% if user_answer_data.is_correct %}
                                                    <i class="bi bi-check-circle-fill course-feedback-correct"></i>
                                                    {% else %}
                                                    <i class="bi bi-x-circle-fill course-feedback-incorrect"></i>
                                                    {% endif %}
                                                {% elif option.is_correct %}
                                                    <span class="course-correct-indicator">Resposta Correta</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% elif question.question_type.name == 'TEXT_INPUT' %}
                                    <div class="course-text-answer">
                                        <textarea class="course-text-input course-text-readonly" rows="3" readonly>{% if user_answer_data %}{{ user_answer_data.answer }}{% endif %}</textarea>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                
                                <div class="course-form-actions">
                                    <a href="{{ url_for('training.course_list_page') }}" class="course-btn course-btn-primary course-btn-lg">
                                        <i class="bi bi-collection-play-fill"></i>
                                        Voltar aos Cursos
                                    </a>
                                </div>
                            </form>
                        </div>
                        {% else %}
                        <div class="course-quiz-form-container">
                            <div class="course-quiz-form-header">
                                <h5 class="course-quiz-form-title">
                                    <i class="bi bi-pencil-square"></i>
                                    Responda às Questões
                                </h5>
                                <p class="course-quiz-form-description">Complete a avaliação para finalizar o curso</p>
                            </div>
                            
                            <form method="POST" action="{{ url_for('training.submit_quiz', quiz_id=quiz.id) }}" class="course-quiz-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                {% for question in quiz.questions | sort(attribute='id') %}
                                <div class="course-question-item">
                                    <div class="course-question-header">
                                        <span class="course-question-number">{{ loop.index }}</span>
                                        <p class="course-question-text">{{ question.text }}</p>
                                    </div>
                                    
                                    {% if question.question_type.name == 'MULTIPLE_CHOICE' %}
                                    <div class="course-question-options">
                                        {% for option in question.options %}
                                        <div class="course-option-item">
                                            <div class="course-option-content">
                                                <input class="course-option-input" type="radio" name="question_{{ question.id }}" 
                                                       id="option_{{ option.id }}" value="{{ option.id }}" required>
                                                <label class="course-option-label" for="option_{{ option.id }}">{{ option.text }}</label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% elif question.question_type.name == 'TEXT_INPUT' %}
                                    <div class="course-text-answer">
                                        <textarea name="question_{{ question.id }}" class="course-text-input" rows="3" 
                                                  placeholder="Digite sua resposta aqui..." required></textarea>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                
                                <div class="course-form-actions">
                                    <button type="submit" class="course-btn course-btn-success course-btn-lg">
                                        <i class="bi bi-check2-circle"></i>
                                        Enviar Respostas
                                    </button>
                                </div>
                            </form>
                        </div>
                        {% endif %}

                    {% else %}
                        <div class="course-completion-state">
                            <div class="course-completion-icon">
                                <i class="bi bi-trophy-fill"></i>
                            </div>
                            <h4 class="course-completion-title">Parabéns!</h4>
                            <h5 class="course-completion-subtitle">Curso Concluído com Sucesso</h5>
                            <p class="course-completion-text">Você finalizou o curso "{{ course.title }}" e está pronto para aplicar os conhecimentos adquiridos.</p>
                            <div class="course-completion-actions">
                                <a href="{{ url_for('training.view_certificate', course_id=course.id) }}" 
                                   target="_blank"
                                   rel="noopener"
                                   class="course-btn course-btn-success course-btn-lg">
                                    <i class="bi bi-award-fill"></i>
                                    Imprimir Certificado
                                </a>
                                <a href="{{ url_for('training.course_list_page') }}" class="course-btn course-btn-primary course-btn-lg">
                                    <i class="bi bi-collection-play-fill"></i>
                                    Explorar Mais Cursos
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const contentType = '{{ content_type }}';
    const video = document.getElementById('course-video');
    const contentWrapper = document.getElementById('course-content-wrapper');
    const statusContainer = document.getElementById('quiz-container');
    const courseId = '{{ course.id }}';
    const hasQuiz = {{ has_quiz | default(false, true) | tojson }};
    let isCompleted = {{ is_completed | tojson }};

    const saveProgress = (timestamp, finished = false) => {
        return fetch('/course/' + courseId + '/progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timestamp, finished })
        })
        .then(response => response.json())
        .then(data => {
            if (data.completed) {
                isCompleted = true;
                if (contentWrapper && contentType === 'video') {
                    contentWrapper.style.display = 'none';
                }
                if (statusContainer) {
                    statusContainer.style.display = 'block';
                }
            }
            return data;
        })
        .catch(() => ({ success: false }));
    };

    if (contentType === 'video' && video && !isCompleted) {
        let lastUpdateTime = 0;

        video.addEventListener('timeupdate', () => {
            const currentTime = Math.floor(video.currentTime);
            if (currentTime > lastUpdateTime + 9) {
                saveProgress(currentTime);
                lastUpdateTime = currentTime;
            }
        });

        video.addEventListener('ended', () => {
            saveProgress(video.duration, true).then(() => {
                if (hasQuiz && statusContainer) {
                    statusContainer.style.display = 'block';
                }
            });
        });

        window.addEventListener('beforeunload', () => {
            if (!video.ended) {
                saveProgress(video.currentTime);
            }
        });
    } else if (contentType === 'pdf' && !isCompleted && !hasQuiz) {
        saveProgress(0, true);
    }
});
</script>

{% endblock %}
