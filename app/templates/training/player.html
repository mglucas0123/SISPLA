{% extends "navbar.html" %}
{% block title %}Treinamento: {{ course.title }}{% endblock %}

{% block content %}
<div class="container my-4">
    <h3>{{ course.title }}</h3>
    <p>{{ course.description }}</p>

    <video id="training-video" width="100%" controls controlsList="nodownload noplaybackrate">
        <source src="{{ url_for('training.serve_video', course_id=course.id) }}" type="video/mp4">
        Seu navegador não suporta o player de vídeo.
    </video>

    <div id="status" class="mt-2">Status: Em andamento...</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const video = document.getElementById('training-video');
        const statusDiv = document.getElementById('status');
        const courseId = '{{ course.id }}';

        let lastKnownTimestamp = '{{ progress.last_watched_timestamp }}';

        video.currentTime = lastKnownTimestamp;

        video.addEventListener('seeking', function () {
            if (video.currentTime > lastKnownTimestamp + 2) {
                video.currentTime = lastKnownTimestamp;
                alert("Para concluir o treinamento, você precisa assistir ao vídeo na sequência.");
            }
        });

        video.addEventListener('timeupdate', function () {
            if (video.currentTime > lastKnownTimestamp) {
                lastKnownTimestamp = video.currentTime;
            }
        });

        setInterval(function () {
            if (!video.paused) {
                fetch(`{{ url_for('training.save_progress') }}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        course_id: courseId,
                        timestamp: video.currentTime
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`Progresso salvo em: ${data.last_timestamp.toFixed(2)}s`);
                        }
                    });
            }
        }, 10000);
        video.addEventListener('ended', function () {
            statusDiv.innerHTML = '<span class="text-success fw-bold">Parabéns, treinamento concluído!</span>';

            fetch(`{{ url_for('training.save_progress') }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    course_id: courseId,
                    timestamp: video.currentTime
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log('Status final salvo com sucesso!');
                    } else {
                        console.error('Falha ao salvar o status final.');
                    }
                });
        });
    });
</script>
{% endblock %}