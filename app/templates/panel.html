{% extends "navbar.html" %}
{% block title %} Painel Principal {% endblock %}

{% block content %}
<!-- Seção do Jornal SBCD -->
{% include 'partials/_jornal_section.html' %}
<div class="container-fluid px-4 py-4 dashboard-container">

    {% include 'partials/_flash_messages.html' %}

    <!-- Módulos do Sistema -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="section-header-modern">
                <div class="section-icon-wrapper">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                </div>
                <div class="section-header-content">
                    <h2 class="section-title">Módulos do Sistema</h2>
                    <p class="section-subtitle">Acesse os recursos e ferramentas disponíveis</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- NIR - Internações -->
        <div class="col-xl-3 col-lg-6">
            <div class="enterprise-module-card card-accent-danger" data-aos="fade-up">
                <div class="card-header-section">
                    <div class="module-icon-enterprise danger">
                        <i class="bi bi-hospital"></i>
                    </div>
                    <div class="module-meta">
                        <h3 class="module-name">NIR</h3>
                        <span class="module-category">Notificações de Internação</span>
                    </div>
                </div>
                <div class="card-content-section">
                    <p class="module-desc">Gerenciamento e acompanhamento de notificações de internação por setor e especialidade</p>
                </div>
                <div class="card-actions-section">
                    {% for role in current_user.roles %}
                    {% if role.sector in ['NIR', 'TI', 'CENTRO_CIRURGICO', 'FATURAMENTO'] %}
                    <a href="{{ url_for('nir.my_work') }}" class="btn-enterprise btn-primary-enterprise">
                        <i class="bi bi-briefcase"></i>
                        <span>Meus Trabalhos</span>
                    </a>
                    {% endif %}
                    {% endfor %}
                    <a href="{{ url_for('nir.list_records') }}" class="btn-enterprise btn-secondary-enterprise">
                        <i class="bi bi-list-check"></i>
                        <span>Ver Registros</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Passagem de Plantão -->
        <div class="col-xl-3 col-lg-6">
            <div class="enterprise-module-card card-accent-success" data-aos="fade-up" data-aos-delay="200">
                <div class="card-header-section">
                    <div class="module-icon-enterprise success">
                        <i class="bi bi-arrow-left-right"></i>
                    </div>
                    <div class="module-meta">
                        <h3 class="module-name">Plantão</h3>
                        <span class="module-category">Passagem de Turno</span>
                    </div>
                </div>
                <div class="card-content-section">
                    <p class="module-desc">Sistema de registro e comunicação entre equipes nas transições de turnos</p>
                </div>
                <div class="card-actions-section">
                    {% if current_user.has_permission('criar-registro-plantao') or current_user.has_permission('admin-total') %}
                    <a href="{{ url_for('shift_handover.new_shift_handover_record') }}" class="btn-enterprise btn-primary-enterprise">
                        <i class="bi bi-plus-circle"></i>
                        <span>Novo Registro</span>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('shift_handover.shift_handover_records') }}" class="btn-enterprise btn-secondary-enterprise">
                        <i class="bi bi-list-check"></i>
                        <span>Ver Registros</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Repositório de Arquivos -->
        <div class="col-xl-3 col-lg-6">
            <div class="enterprise-module-card card-accent-primary" data-aos="fade-up" data-aos-delay="100">
                <div class="card-header-section">
                    <div class="module-icon-enterprise primary">
                        <i class="bi bi-folder-fill"></i>
                    </div>
                    <div class="module-meta">
                        <h3 class="module-name">Repositório</h3>
                        <span class="module-category">Gestão Documental</span>
                    </div>
                </div>
                <div class="card-content-section">
                    <p class="module-desc">Central de armazenamento e organização de documentos e arquivos institucionais</p>
                </div>
                <div class="card-actions-section">
                    <a href="{{ url_for('repository.repository_list_page') }}" class="btn-enterprise btn-primary-enterprise">
                        <i class="bi bi-folder-open"></i>
                        <span>Acessar Repositório</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Treinamentos -->
        <div class="col-xl-3 col-lg-6">
            <div class="enterprise-module-card card-accent-warning" data-aos="fade-up" data-aos-delay="300">
                <div class="card-header-section">
                    <div class="module-icon-enterprise warning">
                        <i class="bi bi-mortarboard-fill"></i>
                    </div>
                    <div class="module-meta">
                        <h3 class="module-name">Treinamentos</h3>
                        <span class="module-category">Capacitação</span>
                    </div>
                </div>
                <div class="card-content-section">
                    <p class="module-desc">Plataforma de desenvolvimento profissional e educação continuada</p>
                </div>
                <div class="card-actions-section">
                    <a href="{{ url_for('training.course_list_page') }}" class="btn-enterprise btn-primary-enterprise">
                        <i class="bi bi-play-circle"></i>
                        <span>Acessar Cursos</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Avaliação de Fornecedores -->
        <div class="col-xl-3 col-lg-6">
            <div class="enterprise-module-card card-accent-info" data-aos="fade-up" data-aos-delay="400">
                <div class="card-header-section">
                    <div class="module-icon-enterprise info">
                        <i class="bi bi-clipboard-check"></i>
                    </div>
                    <div class="module-meta">
                        <h3 class="module-name">Fornecedores</h3>
                        <span class="module-category">Avaliação de Prestadores</span>
                    </div>
                </div>
                <div class="card-content-section">
                    <p class="module-desc">Sistema de avaliação mensal de fornecedores e prestadores de serviços com ranking de desempenho</p>
                </div>
                <div class="card-actions-section">
                    <a href="{{ url_for('suppliers.dashboard') }}" class="btn-enterprise btn-primary-enterprise">
                        <i class="bi bi-graph-up"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="{{ url_for('suppliers.evaluate_supplier') }}" class="btn-enterprise btn-secondary-enterprise">
                        <i class="bi bi-clipboard-check"></i>
                        <span>Avaliar</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark mb-0">
                    <i class="bi bi-megaphone-fill text-info me-2"></i>
                    Mural de Avisos
                </h3>
                {% if notice %}
                <span class="badge bg-info text-white px-3 py-2">{{ notice|length }} avisos</span>
                {% endif %}
            </div>

            {% if notice %}
            <div class="notices-container">
                {% for n in notice %}
                <div class="notice-card mb-4">
                    {% if n.notice_type == 'IMAGE' and n.image_filename %}
                    <div class="notice-header">
                        <div class="notice-meta">
                            <span class="notice-date">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ n.date_registry | format_date_time }}
                            </span>
                        </div>
                    </div>
                    <div class="notice-content text-center">
                        <div class="notice-image-container">
                            <a href="#" class="d-block position-relative" data-bs-toggle="modal"
                                data-bs-target="#imageNoticeModal"
                                data-img-src="{{ url_for('admin.notices.serve_notice_image', filename=n.image_filename) }}">
                                <img src="{{ url_for('admin.notices.serve_notice_image', filename=n.image_filename) }}"
                                    class="img-fluid rounded-3 shadow-sm notice-image" alt="Aviso em imagem">
                                <div class="image-overlay">
                                    <i class="bi bi-arrows-fullscreen text-white fs-2"></i>
                                    <p class="text-white mt-2 mb-0">Clique para ampliar</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="notice-header">
                        <h5 class="notice-title">{{ n.title }}</h5>
                        <div class="notice-meta">
                            <span class="notice-date">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ n.date_registry | format_date_time }}
                            </span>
                        </div>
                    </div>
                    <div class="notice-content">
                        <div class="notice-text">{{ n.content | safe }}</div>
                    </div>
                    {% endif %}

                    <div class="notice-footer">
                        <div class="author-info">
                            <i class="bi bi-person-circle me-2"></i>
                            <span>Publicado por <strong>{{ n.author.name }}</strong></span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state text-center py-5">
                <div class="empty-icon mb-3">
                    <i class="bi bi-megaphone text-muted" style="font-size: 4rem;"></i>
                </div>
                <h5 class="text-muted mb-2">Nenhum aviso no momento</h5>
                <p class="text-muted">Os avisos importantes aparecerão aqui quando forem publicados.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<div class="modal fade" id="imageNoticeModal" tabindex="-1" aria-labelledby="imageNoticeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 position-relative text-center">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 p-2"
                    style="z-index: 10; background-color: rgba(0,0,0,0.5); border-radius: 50%;" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>

                <img id="modalNoticeImage" src="" class="img-fluid rounded" alt="Imagem do Aviso"
                    style="max-height: 90vh; object-fit: contain;">
            </div>
        </div>
    </div>
</div>
<!-- Modal de Comunicado Popup -->
{% if popup_aviso %}
<div class="modal fade" id="avisoModal" tabindex="-1" aria-labelledby="avisoModalLabel" aria-hidden="true">
    {% if popup_aviso.notice_type == 'IMAGE' and popup_aviso.image_filename %}
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content enterprise-modal">
            <button type="button" class="btn-close-modern" data-bs-dismiss="modal" aria-label="Fechar">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="modal-body p-0">
                <img src="{{ url_for('admin.notices.serve_notice_image', filename=popup_aviso.image_filename) }}"
                    class="img-fluid w-100" alt="Comunicado" style="max-height: 85vh; object-fit: contain;">
            </div>
        </div>
    </div>
    {% else %}
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content enterprise-modal">
            <div class="modal-header-modern">
                <div class="modal-icon-badge">
                    <i class="bi bi-megaphone-fill"></i>
                </div>
                <button type="button" class="btn-close-modern" data-bs-dismiss="modal" aria-label="Fechar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <h3 class="modal-title-modern">{{ popup_aviso.title }}</h3>
                <div class="modal-content-text">{{ popup_aviso.content | safe }}</div>
                <div class="modal-meta-info">
                    <div class="meta-info-item">
                        <i class="bi bi-person-circle"></i>
                        <span><strong>Publicado por:</strong> {{ popup_aviso.author.name }}</span>
                    </div>
                    <div class="meta-info-item">
                        <i class="bi bi-calendar-check"></i>
                        <span><strong>Data:</strong> {{ popup_aviso.date_registry | format_date_time }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button type="button" class="btn-enterprise btn-primary-enterprise btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle"></i>
                    <span>Compreendido</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function updateDateTime() {
            const dateElement = document.getElementById('currentDate');
            const timeElement = document.getElementById('currentTime');
            
            if (dateElement) {
                const options = { day: '2-digit', month: 'short', year: 'numeric' };
                const today = new Date().toLocaleDateString('pt-BR', options);
                dateElement.textContent = today.replace('.', '').toUpperCase();
            }
            
            if (timeElement) {
                const time = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                timeElement.textContent = time;
            }
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000);

        const avisoModalElement = document.getElementById('avisoModal');
        if (avisoModalElement) {
            const avisoModal = new bootstrap.Modal(avisoModalElement);
            avisoModal.show();
        }

        const cards = document.querySelectorAll('[data-aos]');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        const heroCarousel = document.getElementById('heroCarousel');
        if (heroCarousel) {
            const bsCarousel = new bootstrap.Carousel(heroCarousel, {
                interval: 6000,
                pause: 'hover',
                wrap: true
            });
            
            heroCarousel.addEventListener('slide.bs.carousel', function (e) {
                const activeSlide = e.relatedTarget;
                const iconBox = activeSlide.querySelector('.hero-icon-box');
                
                if (iconBox) {
                    iconBox.style.animation = 'none';
                    setTimeout(() => {
                        iconBox.style.animation = '';
                    }, 10);
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    bsCarousel.prev();
                } else if (e.key === 'ArrowRight') {
                    bsCarousel.next();
                }
            });
        }

        // Modal de imagem - atualizar src quando abrir
        const imageNoticeModal = document.getElementById('imageNoticeModal');
        if (imageNoticeModal) {
            imageNoticeModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const imgSrc = button.getAttribute('data-img-src');
                const modalImage = document.getElementById('modalNoticeImage');
                if (modalImage && imgSrc) {
                    modalImage.src = imgSrc;
                }
            });
        }
    });
</script>
{% endblock %}
