{% extends "feedback/suppliers/base.html" %}
{% from 'partials/feedback/suppliers/_hero.html' import hero %}

{% block supplier_title %}Dashboard de Fornecedores - SISPLA{% endblock %}

{% block supplier_hero %}
{% set scored_suppliers = suppliers_data|selectattr('avg_score', 'gt', 0)|list %}
{% set avg_score = (scored_suppliers|sum(attribute='avg_score') / (scored_suppliers|length)) if scored_suppliers|length
> 0 else 0 %}
{% set hero_stats = [
{ 'icon': 'bi bi-building-fill', 'value': total_suppliers, 'label': 'Fornecedores' },
{ 'icon': 'bi bi-clipboard-check-fill', 'value': total_evaluations, 'label': 'Avaliações' },
{ 'icon': 'bi bi-percent', 'value': "%.0f"|format(avg_score) ~ '%', 'label': 'Score Médio' }
] %}
{{ hero('<i class="bi bi-graph-up"></i> Dashboard de Fornecedores'|safe, 'Gestão inteligente, análise profunda e
decisões estratégicas', hero_stats) }}
{% endblock %}

{% block supplier_content %}
<div class="supplier-dashboard-container">
    <div class="row">
        <div class="col-lg-8">
            <div class="dashboard-card top-suppliers-card">
                <div class="card-header-dash">
                    <div class="header-title">
                        <h2><i class="bi bi-trophy"></i> Top 3 Melhores Fornecedores</h2>
                        <span class="badge badge-success">Excelência</span>
                    </div>
                    <p class="header-subtitle">Fornecedores com melhor desempenho</p>
                </div>
                <div class="ranking-list premium">
                    {% if top_suppliers %}
                    {% for data in top_suppliers[:3] %}
                    <a href="{{ url_for('suppliers.supplier_evaluations', supplier_id=data.supplier.id) }}"
                        class="ranking-item-premium {{ 'rank-1' if loop.index == 1 else ('rank-2' if loop.index == 2 else 'rank-3') }}">
                        <div class="rank-medal">
                            <div
                                class="medal-wrapper {{ 'gold' if loop.index == 1 else ('silver' if loop.index == 2 else 'bronze') }}">
                                <i class="bi bi-award-fill"></i>
                            </div>
                            <span class="rank-badge">#{{ loop.index }}</span>
                        </div>
                        <div class="rank-content">
                            <div class="rank-header">
                                <h3
                                    title="{% if data.supplier.trade_name %}Razão Social: {{ data.supplier.company_name }}{% endif %}">
                                    {{ data.supplier.get_display_name() }}
                                </h3>
                                <div
                                    class="rank-score-badge {{ 'excellent' if data.avg_score >= 80 else ('good' if data.avg_score >= 60 else 'poor') }}">
                                    {{ '%.0f'|format(data.avg_score) }}%
                                </div>
                            </div>
                            <div class="rank-meta-info">
                                <span class="meta-item">
                                    <i class="bi bi-star-fill"></i>
                                    {% set stars = (data.avg_score / 10)|round|int // 2 %}
                                    {% for i in range(stars) %}
                                    <i class="bi bi-star-fill"></i>
                                    {% endfor %}
                                    {% for i in range(5 - stars) %}
                                    <i class="bi bi-star"></i>
                                    {% endfor %}
                                </span>
                                <span class="meta-item">
                                    <i class="bi bi-clipboard-check"></i> {{ data.eval_count }} avaliações
                                </span>
                                {% if data.last_eval_date %}
                                <span class="meta-item">
                                    <i class="bi bi-calendar-event"></i> {{ data.last_eval_date.strftime('%d/%m/%Y') }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="rank-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-fill {{ 'excellent' if data.avg_score >= 80 else ('good' if data.avg_score >= 60 else 'poor') }}"
                                        style="width: {{ data.avg_score }}%"></div>
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                    {% else %}
                    <div class="empty-ranking">
                        <div class="empty-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <p>Nenhum fornecedor avaliado ainda</p>
                        <small>Realize avaliações para ver os melhores fornecedores</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="dashboard-card">
                <div class="card-header-dash">
                    <div class="d-flex align-items-center justify-content-between w-100">
                        <h2 class="mb-0"><i class="bi bi-list-ol"></i> Lista de Fornecedores</h2>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted fw-semibold">
                                <i class="bi bi-list-check me-2"></i>{{ suppliers_data|length }} fornecedores
                            </span>
                            <select class="form-select form-select-sm" id="sortOrder"
                                style="width: auto; min-width: 150px;">
                                <option value="desc">Maior Score</option>
                                <option value="asc">Menor Score</option>
                                <option value="name">Nome A-Z</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="nir-table-modern-wrapper">
                    <div class="table-responsive">
                        <table class="nir-table-modern" id="rankingTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th><i class="bi bi-building me-1"></i>Fornecedor</th>
                                    <th><i class="bi bi-clipboard-check me-1"></i>Avaliações</th>
                                    <th><i class="bi bi-graph-up me-1"></i>Score</th>
                                    <th><i class="bi bi-flag me-1"></i>Status</th>
                                    <th><i class="bi bi-gear me-1"></i>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in suppliers_data %}
                                {% set last_eval = data.last_eval %}
                                {% set failing_eval = data.failing_eval %}
                                {% set needs_attention = data.needs_attention %}
                                {% set row_class = '' %}
                                {% if needs_attention and not data.supplier.issue_verified %}
                                {% set row_class = 'supplier-row-attention' %}
                                {% elif needs_attention and data.supplier.issue_verified %}
                                {% set row_class = 'supplier-row-verified' %}
                                {% elif data.eval_count > 0 and data.avg_score >= 80 %}
                                {% set row_class = 'supplier-row-excellent' %}
                                {% elif data.eval_count > 0 and data.avg_score >= 70 %}
                                {% set row_class = 'supplier-row-satisfactory' %}
                                {% endif %}
                                <tr class="supplier-row {{ row_class }}" data-score="{{ data.avg_score }}"
                                    data-name="{{ data.supplier.get_display_name() }}"
                                    data-supplier-id="{{ data.supplier.id }}" data-priority="{{ data.priority }}">
                                    <td class="cell-id">
                                        <span class="badge fw-bold">#{{ loop.index }}</span>
                                    </td>
                                    <td class="cell-supplier">
                                        <div class="d-flex flex-column">
                                            <strong class="mb-1">
                                                {{ data.supplier.get_display_name() }}
                                                {% if data.supplier.issue_verified %}
                                                <span class="badge bg-success rounded-pill ms-2"
                                                    title="Problema verificado em {{ data.supplier.verified_at.strftime('%d/%m/%Y às %H:%M') if data.supplier.verified_at else '' }}">
                                                    <i class="bi bi-check-circle-fill me-1"></i>Verificado
                                                </span>
                                                {% endif %}
                                            </strong>
                                            {% if data.supplier.trade_name %}
                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                <i class="bi bi-building me-1"></i>{{ data.supplier.company_name }}
                                            </small>
                                            {% endif %}
                                            {% if data.supplier.cnpj %}
                                            <small class="text-muted">CNPJ: {{ data.supplier.cnpj }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge {{ 'bg-custom-blue' if data.eval_count > 0 else 'bg-secondary' }} rounded-pill">
                                            {{ data.eval_count }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if data.eval_count > 0 %}
                                        <div
                                            class="score-badge-sm {{ 'excellent' if data.avg_score >= 80 else ('good' if data.avg_score >= 60 else 'poor') }}">
                                            {{ '%.0f'|format(data.avg_score) }}%
                                        </div>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if data.eval_count == 0 %}
                                        <span class="badge bg-custom-gray rounded-pill">Não Avaliado</span>
                                        {% else %}
                                        {% if last_eval and not last_eval.had_service_last_month %}
                                        <span class="badge bg-custom-yellow rounded-pill">
                                            <i class="bi bi-info-circle me-1"></i>Sem Serviço
                                        </span>
                                        {% elif data.avg_score >= 80 %}
                                        <span class="badge bg-custom-green rounded-pill">
                                            <i class="bi bi-check-circle me-1"></i>Excelente
                                        </span>
                                        {% elif data.avg_score >= 60 %}
                                        <span class="badge bg-custom-blue rounded-pill">
                                            <i class="bi bi-info-circle me-1"></i>Satisfatório
                                        </span>
                                        {% else %}
                                        <span class="badge bg-custom-red rounded-pill">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Insatisfatório
                                        </span>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-2">
                                            {% if needs_attention and not data.supplier.issue_verified %}
                                            <button type="button"
                                                class="btn btn-sm btn-primary rounded-pill shadow-sm toggle-detail-supplier"
                                                data-detail-id="detail-supplier-{{ data.supplier.id }}"
                                                title="Ver motivo da atenção">
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                <span class="btn-text">Verificar</span>
                                            </button>
                                            {% elif needs_attention and data.supplier.issue_verified %}
                                            <button type="button"
                                                class="btn btn-sm btn-success rounded-pill shadow-sm toggle-detail-supplier"
                                                data-detail-id="detail-supplier-{{ data.supplier.id }}"
                                                title="Ver detalhes da verificação">
                                                <i class="bi bi-check-circle-fill me-1"></i>
                                                <span class="btn-text">Verificado</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% if needs_attention %}
                                <tr id="detail-supplier-{{ data.supplier.id }}" class="detail-row"
                                    style="display:none;">
                                    <td colspan="7" class="p-0">
                                        <div class="inline-detail-card">
                                            <div class="inline-detail-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">
                                                        <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
                                                        Atenção Necessária - {{ data.supplier.get_display_name() }}
                                                    </h5>
                                                    <div class="d-flex align-items-center gap-2">
                                                        {% if data.eval_count > 0 %}
                                                        <span
                                                            class="badge {{ 'bg-danger' if data.avg_score < 60 else 'bg-warning' }}">
                                                            <i class="bi bi-graph-down me-1"></i>Score: {{
                                                            '%.0f'|format(data.avg_score) }}%
                                                        </span>
                                                        {% endif %}
                                                        {% if data.supplier.issue_verified %}
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle-fill me-1"></i>Verificado
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="inline-detail-body">
                                                <div class="alert alert-warning mb-3 py-2">
                                                    <i class="bi bi-info-circle-fill me-2"></i>
                                                    <strong>Motivo:</strong>
                                                    {% if last_eval and not last_eval.had_service_last_month %}
                                                    Sem fornecimento/prestação de serviço no último mês
                                                    {% else %}
                                                    Score abaixo do esperado ({{ '%.0f'|format(data.avg_score) }}%) -
                                                    necessita revisão
                                                    {% endif %}
                                                </div>
                                                {% if data.supplier.issue_verified %}
                                                <div class="alert alert-success mb-3 py-2">
                                                    <i class="bi bi-check-circle-fill me-2"></i>
                                                    <strong>Status:</strong> Problema verificado
                                                    {% if data.supplier.verified_at %}
                                                    em {{ data.supplier.verified_at.strftime('%d/%m/%Y às %H:%M') }}
                                                    {% endif %}
                                                    {% if data.supplier.verified_by %}
                                                    por {{ data.supplier.verified_by.name }}
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                <p class="text-muted mb-3 text-center">
                                                    <i class="bi bi-lightbulb me-2"></i>
                                                    Escolha uma ação para revisar o desempenho do fornecedor.
                                                </p>
                                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                                    {% if failing_eval %}
                                                    <a href="{{ url_for('suppliers.evaluation_details', evaluation_id=failing_eval.id) }}"
                                                        class="btn btn-primary">
                                                        <i class="bi bi-clipboard-check me-1"></i>Ver Detalhes
                                                    </a>
                                                    {% endif %}
                                                    <a href="{{ url_for('suppliers.supplier_evaluations', supplier_id=data.supplier.id) }}"
                                                        class="btn btn-info">
                                                        <i class="bi bi-clock-history me-1"></i>Histórico de Avaliações
                                                    </a>
                                                    <button type="button"
                                                        class="btn btn-{{ 'success' if not data.supplier.issue_verified else 'warning' }} btn-lg open-tracking-modal"
                                                        data-supplier-id="{{ data.supplier.id }}"
                                                        data-supplier-name="{{ data.supplier.get_display_name() }}"
                                                        data-supplier-cnpj="{{ data.supplier.cnpj }}">
                                                        <i class="bi bi-clipboard-check-fill me-1"></i>
                                                        Gerenciar Acompanhamento
                                                    </button>
                                                    <button type="button"
                                                        class="btn btn-secondary cancel-supplier-panel"
                                                        data-supplier-id="{{ data.supplier.id }}">
                                                        <i class="bi bi-x-circle me-1"></i>Fechar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="dashboard-card performance-card">
                <div class="card-header-dash">
                    <h2><i class="bi bi-pie-chart"></i> Distribuição de Performance</h2>
                </div>
                <div class="chart-container">
                    {% set excellent_count = suppliers_data|selectattr('avg_score', 'ge', 80)|list|length %}
                    {% set good_count = suppliers_data|selectattr('avg_score', 'ge', 60)|selectattr('avg_score', 'lt',
                    80)|list|length %}
                    {% set poor_count = suppliers_data|selectattr('avg_score', 'lt', 60)|selectattr('eval_count', 'gt',
                    0)|list|length %}
                    {% set not_eval_count = suppliers_data|selectattr('eval_count', 'eq', 0)|list|length %}
                    {% set excellent_pct = (excellent_count / total_suppliers * 100) if total_suppliers > 0 else 0 %}
                    {% set good_pct = (good_count / total_suppliers * 100) if total_suppliers > 0 else 0 %}
                    {% set poor_pct = (poor_count / total_suppliers * 100) if total_suppliers > 0 else 0 %}
                    {% set not_eval_pct = (not_eval_count / total_suppliers * 100) if total_suppliers > 0 else 0 %}
                    <div class="performance-content">
                        <div class="performance-donut">
                            <svg viewBox="0 0 140 140" class="donut-chart" preserveAspectRatio="xMidYMid meet">
                                <circle cx="70" cy="70" r="60" fill="none" stroke="#e2e5ee" stroke-width="25"></circle>
                                <circle cx="70" cy="70" r="40" fill="none" stroke="#e2e5ee" stroke-width="25"></circle>
                                <circle cx="70" cy="70" r="54" fill="none" stroke="#e3e6f0" stroke-width="25"></circle>
                                {% if excellent_count > 0 %}
                                <circle cx="70" cy="70" r="54" fill="none" stroke="#10b981" stroke-width="25"
                                    stroke-dasharray="{{ (excellent_pct / 100) * 339.3 }} 339.3" stroke-dashoffset="0"
                                    stroke-linecap="round" class="donut-segment" data-category="excellent"
                                    data-label="Excelentes (≥80%)" data-color="#10b981"></circle>
                                {% endif %}
                                {% if good_count > 0 %}
                                <circle cx="70" cy="70" r="54" fill="none" stroke="#f59e0b" stroke-width="25"
                                    stroke-dasharray="{{ (good_pct / 100) * 339.3 }} 339.3"
                                    stroke-dashoffset="-{{ (excellent_pct / 100) * 339.3 }}" stroke-linecap="round"
                                    class="donut-segment" data-category="good" data-label="Satisfatórios (60-79%)"
                                    data-color="#f59e0b"></circle>
                                {% endif %}
                                {% if poor_count > 0 %}
                                <circle cx="70" cy="70" r="54" fill="none" stroke="#ef4444" stroke-width="25"
                                    stroke-dasharray="{{ (poor_pct / 100) * 339.3 }} 339.3"
                                    stroke-dashoffset="-{{ ((excellent_pct + good_pct) / 100) * 339.3 }}"
                                    stroke-linecap="round" class="donut-segment" data-category="poor"
                                    data-label="Insatisfatórios (<60%)" data-color="#ef4444"></circle>
                                {% endif %}
                                {% if not_eval_count > 0 %}
                                <circle cx="70" cy="70" r="54" fill="none" stroke="#cbd5e1" stroke-width="25"
                                    stroke-dasharray="{{ (not_eval_pct / 100) * 339.3 }} 339.3"
                                    stroke-dashoffset="-{{ ((excellent_pct + good_pct + poor_pct) / 100) * 339.3 }}"
                                    stroke-linecap="round" class="donut-segment" data-category="notEval"
                                    data-label="Não Avaliados" data-color="#cbd5e1"></circle>
                                {% endif %}
                                <text x="70" y="75" text-anchor="middle" font-size="24" font-weight="bold"
                                    fill="#2c3e50">{{ total_suppliers }}</text>
                                <text x="70" y="88" text-anchor="middle" font-size="10" fill="#7f8c8d">Total</text>
                            </svg>
                        </div>
                        <div class="performance-legend">
                            <div class="legend-item">
                                <div class="legend-color excellent"></div>
                                <div class="legend-content">
                                    <span class="legend-label">Excelentes</span>
                                    <span class="legend-value">{{ excellent_count }} ({{ '%.0f'|format(excellent_pct)
                                        }}%)</span>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color good"></div>
                                <div class="legend-content">
                                    <span class="legend-label">Satisfatórios</span>
                                    <span class="legend-value">{{ good_count }} ({{ '%.0f'|format(good_pct) }}%)</span>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color poor"></div>
                                <div class="legend-content">
                                    <span class="legend-label">Insatisfatórios</span>
                                    <span class="legend-value">{{ poor_count }} ({{ '%.0f'|format(poor_pct) }}%)</span>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color not-eval"></div>
                                <div class="legend-content">
                                    <span class="legend-label">Não Avaliados</span>
                                    <span class="legend-value">{{ not_eval_count }} ({{ '%.0f'|format(not_eval_pct)
                                        }}%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card insights-card">
                    <div class="card-header-dash">
                        <h2><i class="bi bi-lightbulb"></i> Insights</h2>
                    </div>
                    <div class="insights-list">
                        {% if problematic_count > 0 %}
                        <div class="insight-item warning">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <p><strong>{{ problematic_count }}</strong> fornecedor(es) com score abaixo de 60%.</p>
                        </div>
                        {% endif %}
                        {% if top_suppliers|length > 0 %}
                        <div class="insight-item success">
                            <i class="bi bi-trophy-fill"></i>
                            <p>Fornecedor destaque: <strong>{{ top_suppliers[0].supplier.get_display_name() }}</strong>
                                com {{ '%.0f'|format(top_suppliers[0].avg_score) }}%</p>
                        </div>
                        {% endif %}
                        {% set not_evaluated = suppliers_data|selectattr('eval_count', 'eq', 0)|list|length %}
                        {% if not_evaluated > 0 %}
                        <div class="insight-item info">
                            <i class="bi bi-info-circle-fill"></i>
                            <p><strong>{{ not_evaluated }}</strong> fornecedor(es) ainda não possui(em) avaliação.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'partials/feedback/suppliers/_tracking_modal.html' %}

    <script type="application/json" id="suppliers-dashboard-data">
    {
        "excellent": [
            {% set comma = joiner(',') %}
            {% for data in suppliers_data if data.avg_score >= 80 %}
                {{ comma() }}{ "name": "{{ data.supplier.get_display_name()|e }}", "score": {{ '%.1f'|format(data.avg_score) }} }
            {% endfor %}
        ],
        "good": [
            {% set comma = joiner(',') %}
            {% for data in suppliers_data if data.avg_score >= 60 and data.avg_score < 80 %}
                {{ comma() }}{ "name": "{{ data.supplier.get_display_name()|e }}", "score": {{ '%.1f'|format(data.avg_score) }} }
            {% endfor %}
        ],
        "poor": [
            {% set comma = joiner(',') %}
            {% for data in suppliers_data if data.avg_score < 60 and data.eval_count > 0 %}
                {{ comma() }}{ "name": "{{ data.supplier.get_display_name()|e }}", "score": {{ '%.1f'|format(data.avg_score) }} }
            {% endfor %}
        ],
        "notEval": [
            {% set comma = joiner(',') %}
            {% for data in suppliers_data if data.eval_count == 0 %}
                {{ comma() }}{ "name": "{{ data.supplier.get_display_name()|e }}", "score": 0 }
            {% endfor %}
        ]
    }
    </script>
</div>
{% endblock %}

{% block supplier_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/suppliers/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/suppliers/tracking.js') }}"></script>
<script src="{{ url_for('static', filename='js/suppliers/dashboard.js') }}"></script>
{% endblock %}