{% extends "navbar.html" %}

{% block title %}Avaliações de {{ supplier.get_display_name() }} - SISPLA{% endblock %}

{% block content %}
<div class="evaluations-modern-container">
    <div class="evaluations-hero">
        <div class="container">
            <div class="hero-navigation">
                <a href="{{ url_for('suppliers.supplier_list') }}" class="btn-back-hero">
                    <i class="bi bi-arrow-left-circle"></i>
                    <span>Voltar para Lista</span>
                </a>
            </div>
            
            <div class="hero-content-eval">
                <div class="hero-supplier-info">
                    <div class="supplier-avatar-large">
                        <i class="bi bi-building-fill"></i>
                    </div>
                    <div class="supplier-details">
                        <span class="supplier-label">Histórico de Avaliações</span>
                        <h1 class="supplier-name-hero">{{ supplier.get_display_name() }}</h1>
                        {% if supplier.trade_name %}
                        <div class="supplier-legal-name-hero">
                            <i class="bi bi-building"></i>
                            Razão Social: {{ supplier.company_name }}
                        </div>
                        {% endif %}
                        {% if supplier.service_type %}
                        <div class="service-tag-hero">
                            <i class="bi bi-tools"></i>
                            {{ supplier.service_type }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="hero-score-display">
                    {% if avg_score > 0 %}
                    <div class="score-circular-hero {{ 'excellent' if avg_score >= 80 else ('good' if avg_score >= 60 else 'poor') }}">
                        <svg width="140" height="140">
                            <circle cx="70" cy="70" r="60" class="score-bg-hero"></circle>
                            <circle cx="70" cy="70" r="60" class="score-fill-hero" 
                                    style="stroke-dashoffset: {{ 377 - (377 * avg_score / 100) }}"></circle>
                        </svg>
                        <div class="score-text-hero">
                            <span class="score-number-hero">{{ "%.0f"|format(avg_score) }}</span>
                            <span class="score-percent-hero">%</span>
                        </div>
                    </div>
                    <div class="score-classification">
                        {% if avg_score >= 80 %}
                        <i class="bi bi-emoji-smile-fill"></i> Desempenho Excelente
                        {% elif avg_score >= 60 %}
                        <i class="bi bi-emoji-neutral-fill"></i> Desempenho Satisfatório
                        {% else %}
                        <i class="bi bi-emoji-frown-fill"></i> Necessita Melhorias
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="score-empty-hero">
                        <i class="bi bi-dash-circle"></i>
                        <span>Sem Avaliações</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="hero-actions-eval">
                    <a href="{{ url_for('suppliers.evaluate_supplier') }}" class="btn-eval-primary">
                        <i class="bi bi-plus-circle-fill"></i>
                        <span>Nova Avaliação</span>
                    </a>
                </div>
            </div>
        </div>
        
    </div>

    <div class="container">
        <!-- Stats Cards -->
        <div class="eval-stats-dashboard">
            <div class="eval-stat-card primary">
                <div class="stat-icon-eval">
                    <i class="bi bi-clipboard-data-fill"></i>
                </div>
                <div class="stat-content-eval">
                    <h3>{{ evaluations|length }}</h3>
                    <p>Total de Avaliações</p>
                </div>
                <div class="stat-chart-mini">
                    <i class="bi bi-graph-up"></i>
                </div>
            </div>

            <div class="eval-stat-card success">
                <div class="stat-icon-eval">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="stat-content-eval">
                    <h3>{{ evaluations|selectattr('is_compliant')|list|length }}</h3>
                    <p>Avaliações Conformes</p>
                </div>
                <div class="stat-percentage">
                    {{ "%.0f"|format((evaluations|selectattr('is_compliant')|list|length / (evaluations|length if evaluations|length > 0 else 1) * 100)) }}%
                </div>
            </div>

            <div class="eval-stat-card danger">
                <div class="stat-icon-eval">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <div class="stat-content-eval">
                    <h3>{{ evaluations|rejectattr('is_compliant')|list|length }}</h3>
                    <p>Não Conformes</p>
                </div>
                {% if evaluations|rejectattr('is_compliant')|list|length > 0 %}
                <div class="stat-pulse-eval"></div>
                {% endif %}
            </div>

            <div class="eval-stat-card warning">
                <div class="stat-icon-eval">
                    <i class="bi bi-star-fill"></i>
                </div>
                <div class="stat-content-eval">
                    <h3>{{ "%.1f"|format(avg_rating) if avg_rating > 0 else "-" }}</h3>
                    <p>Nota Média Atribuída</p>
                </div>
                <div class="rating-stars-mini">
                    {% if avg_rating > 0 %}
                    {% for i in range(1, 6) %}
                        {% if i <= (avg_rating / 2) %}
                        <i class="bi bi-star-fill"></i>
                        {% else %}
                        <i class="bi bi-star"></i>
                        {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Supplier Details Card -->
        <div class="supplier-details-modern">
            <div class="details-header-modern">
                <i class="bi bi-info-circle-fill"></i>
                <h3>Informações do Fornecedor</h3>
            </div>
            
            <div class="details-grid-modern">
                {% if supplier.contact_name %}
                <div class="detail-item-modern">
                    <div class="detail-icon-modern">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="detail-content-modern">
                        <span class="detail-label">Responsável</span>
                        <strong>{{ supplier.contact_name }}</strong>
                    </div>
                </div>
                {% endif %}
                
                {% if supplier.phone %}
                <div class="detail-item-modern">
                    <div class="detail-icon-modern">
                        <i class="bi bi-telephone-fill"></i>
                    </div>
                    <div class="detail-content-modern">
                        <span class="detail-label">Telefone</span>
                        <strong>{{ supplier.phone }}</strong>
                    </div>
                </div>
                {% endif %}
                
                {% if supplier.email %}
                <div class="detail-item-modern">
                    <div class="detail-icon-modern">
                        <i class="bi bi-envelope-fill"></i>
                    </div>
                    <div class="detail-content-modern">
                        <span class="detail-label">E-mail</span>
                        <strong>{{ supplier.email }}</strong>
                    </div>
                </div>
                {% endif %}
                
                {% if supplier.cnpj %}
                <div class="detail-item-modern">
                    <div class="detail-icon-modern">
                        <i class="bi bi-card-text"></i>
                    </div>
                    <div class="detail-content-modern">
                        <span class="detail-label">CNPJ</span>
                        <strong>{{ supplier.cnpj }}</strong>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="supplier-attachments-modern">
            <div class="details-header-modern">
                <i class="bi bi-paperclip"></i>
                <h3>Anexos</h3>
            </div>
            <div class="attachments-actions">
                <form action="{{ url_for('suppliers.upload_supplier_document', supplier_id=supplier.id) }}" method="POST" enctype="multipart/form-data" class="attachments-upload-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="file" name="documents" accept="application/pdf" multiple required class="attachments-file-input">
                    <button type="submit" class="btn btn-sm btn-primary">Enviar</button>
                </form>
            </div>
            <ul class="attachments-list">
                {% for att in attachments %}
                <li class="attachment-item">
                    <i class="bi bi-file-earmark-pdf-fill attachment-icon"></i>
                    <div class="attachment-main">
                        <div class="attachment-title-row">
                            <strong class="attachment-name">{{ att.filename }}</strong>
                            <small class="attachment-size text-muted">&middot; {{ (att.size / 1024)|round(1) }} KB</small>
                        </div>
                        <div class="attachment-meta">{{ att.uploaded_at[:10] if att.uploaded_at else '' }}</div>
                    </div>
                    <div class="attachment-actions">
                        <a href="{{ att.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye-fill"></i>
                        </a>
                        <a href="{{ att.url }}" download="{{ att.filename }}" class="btn btn-sm btn-outline-secondary ms-1">
                            <i class="bi bi-download"></i>
                        </a>
                        <form action="{{ url_for('suppliers.delete_supplier_document', supplier_id=supplier.id) }}" method="POST" class="attachment-delete-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="stored_filename" value="{{ att.stored_filename }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger ms-1" onclick="return confirm('Remover este arquivo?');">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Evaluations Timeline -->
        <div class="evaluations-section-modern">
            <div class="section-header-eval">
                <div class="section-title-group">
                    <i class="bi bi-clock-history"></i>
                    <h2>Histórico de Avaliações</h2>
                </div>
                <div class="section-filters">
                    <select class="filter-select-eval" id="filterPeriod">
                        <option value="all">Todos os Períodos</option>
                        <option value="last-3">Últimos 3 Meses</option>
                        <option value="last-6">Últimos 6 Meses</option>
                        <option value="last-12">Último Ano</option>
                    </select>
                    <select class="filter-select-eval" id="filterStatus">
                        <option value="all">Todos os Status</option>
                        <option value="compliant">Conformes</option>
                        <option value="non-compliant">Não Conformes</option>
                    </select>
                </div>
            </div>

            {% if evaluations %}
            <div class="evaluations-table-compact">
                <table class="eval-table-modern">
                    <thead>
                        <tr>
                            <th class="col-expand"></th>
                            <th class="col-date">
                                <i class="bi bi-calendar-month"></i>
                                Mês Referência
                            </th>
                            <th class="col-evaluated">
                                <i class="bi bi-clock"></i>
                                Data Avaliação
                            </th>
                            <th class="col-score">
                                <i class="bi bi-graph-up"></i>
                                Score
                            </th>
                            <th class="col-rating">
                                <i class="bi bi-star"></i>
                                Nota
                            </th>
                            <th class="col-evaluator">
                                <i class="bi bi-person"></i>
                                Avaliador
                            </th>
                            <th class="col-status">
                                <i class="bi bi-shield-check"></i>
                                Status
                            </th>
                            <th class="col-actions">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for eval in evaluations %}
                        <tr class="eval-row" 
                            data-compliant="{{ 'true' if eval.is_compliant else 'false' }}"
                            data-month="{{ eval.month_reference[:7] if eval.month_reference else '' }}"
                            data-eval-id="{{ eval.id }}">
                            
                            <td class="col-expand">
                                <button class="btn-expand-eval" onclick="toggleEvalRow(this)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </td>
                            
                            <td class="col-date">
                                <strong class="month-display">{{ eval.month_reference[:7] if eval.month_reference else '-' }}</strong>
                            </td>
                            
                            <td class="col-evaluated">
                                <span class="date-display">{{ eval.evaluation_date.strftime('%d/%m/%Y') }}</span>
                            </td>
                            
                            <td class="col-score">
                                <div class="score-inline {{ 'excellent' if eval.total_score >= 80 else ('good' if eval.total_score >= 60 else 'poor') }}">
                                    <div class="score-bar-inline">
                                        <div class="score-fill-inline" style="width: {{ eval.total_score }}%"></div>
                                    </div>
                                    <span class="score-text-inline">{{ "%.0f"|format(eval.total_score) }}%</span>
                                </div>
                            </td>
                            
                            <td class="col-rating">
                                <div class="rating-inline">
                                    <span class="rating-number-inline">{{ eval.overall_rating }}/10</span>
                                    <div class="stars-inline">
                                        {% for i in range(1, 6) %}
                                            {% if i <= (eval.overall_rating / 2) %}
                                            <i class="bi bi-star-fill"></i>
                                            {% else %}
                                            <i class="bi bi-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </td>
                            
                            <td class="col-evaluator">
                                <div class="evaluator-inline">
                                    <div class="evaluator-avatar-mini">
                                        {{ eval.evaluator.name[0]|upper if eval.evaluator else '?' }}
                                    </div>
                                    <span class="evaluator-name">{{ eval.evaluator.name if eval.evaluator else 'N/A' }}</span>
                                </div>
                            </td>
                            
                            <td class="col-status">
                                <span class="status-badge-inline {{ 'compliant' if eval.is_compliant else 'non-compliant' }}">
                                    <i class="bi bi-{{ 'check-circle-fill' if eval.is_compliant else 'x-circle-fill' }}"></i>
                                    {{ 'Conforme' if eval.is_compliant else 'Não Conforme' }}
                                </span>
                            </td>
                            
                            <td class="col-actions">
                                <a href="{{ url_for('suppliers.evaluation_details', evaluation_id=eval.id) }}" 
                                   class="btn-action-eval primary">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                            </td>
                        </tr>
                        
                        <!-- Expanded Details Row -->
                        <tr class="eval-details-row" data-eval-id="{{ eval.id }}">
                            <td colspan="8">
                                <div class="eval-details-content">
                                    <div class="eval-details-grid">
                                        <div class="eval-detail-box">
                                            <span class="detail-label-eval">Avaliador</span>
                                            <div class="detail-value-eval">
                                                <div class="evaluator-avatar-detail-small">
                                                    {{ eval.evaluator.name[0]|upper if eval.evaluator else '?' }}
                                                </div>
                                                <div>
                                                    <strong>{{ eval.evaluator.name if eval.evaluator else 'N/A' }}</strong>
                                                    {% if eval.evaluator and eval.evaluator.job_title %}
                                                    <span class="eval-role">{{ eval.evaluator.job_title }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="eval-detail-box">
                                            <span class="detail-label-eval">Score Total</span>
                                            <div class="detail-value-eval">
                                                <div class="score-circle-detail {{ 'excellent' if eval.total_score >= 80 else ('good' if eval.total_score >= 60 else 'poor') }}">
                                                    {{ "%.0f"|format(eval.total_score) }}%
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="eval-detail-box">
                                            <span class="detail-label-eval">Nota Atribuída</span>
                                            <div class="detail-value-eval">
                                                <strong class="rating-large-detail">{{ eval.overall_rating }}/10</strong>
                                                <div class="stars-detail">
                                                    {% for i in range(1, 11) %}
                                                        {% if i <= eval.overall_rating %}
                                                        <i class="bi bi-star-fill"></i>
                                                        {% else %}
                                                        <i class="bi bi-star"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="eval-detail-box">
                                            <span class="detail-label-eval">Ação</span>
                                            <div class="detail-value-eval">
                                                <a href="{{ url_for('suppliers.evaluation_details', evaluation_id=eval.id) }}" 
                                                   class="btn-details-full">
                                                    <i class="bi bi-file-text-fill"></i>
                                                    Ver Relatório Completo
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state-eval">
                <div class="empty-icon-eval">
                    <i class="bi bi-inbox"></i>
                </div>
                <h3>Nenhuma Avaliação Registrada</h3>
                <p>Este fornecedor ainda não possui avaliações em seu histórico</p>
                <a href="{{ url_for('suppliers.evaluate_supplier') }}" class="btn-eval-primary">
                    <i class="bi bi-plus-circle-fill"></i>
                    <span>Criar Primeira Avaliação</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// ============================================
// FILTROS
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const periodFilter = document.getElementById('filterPeriod');
    const statusFilter = document.getElementById('filterStatus');
    
    if (periodFilter) {
        periodFilter.addEventListener('change', applyFilters);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', applyFilters);
    }
});

function applyFilters() {
    const period = document.getElementById('filterPeriod').value;
    const status = document.getElementById('filterStatus').value;
    
    const rows = document.querySelectorAll('.eval-row');
    const today = new Date();
    
    rows.forEach(row => {
        let show = true;
        const evalId = row.dataset.evalId;
        const detailsRow = document.querySelector(`.eval-details-row[data-eval-id="${evalId}"]`);
        
        // Filtro de status
        if (status !== 'all') {
            const isCompliant = row.dataset.compliant === 'true';
            if (status === 'compliant' && !isCompliant) show = false;
            if (status === 'non-compliant' && isCompliant) show = false;
        }
        
        // Filtro de período
        if (period !== 'all' && row.dataset.month) {
            const [year, month] = row.dataset.month.split('-').map(Number);
            const cardDate = new Date(year, month - 1);
            const monthsDiff = (today.getFullYear() - cardDate.getFullYear()) * 12 + (today.getMonth() - cardDate.getMonth());
            
            if (period === 'last-3' && monthsDiff > 3) show = false;
            if (period === 'last-6' && monthsDiff > 6) show = false;
            if (period === 'last-12' && monthsDiff > 12) show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (detailsRow) {
            detailsRow.style.display = show ? '' : 'none';
        }
    });
}

// ============================================
// EXPANDIR/RECOLHER LINHAS
// ============================================
function toggleEvalRow(button) {
    const row = button.closest('tr');
    const evalId = row.dataset.evalId;
    const detailsRow = document.querySelector(`.eval-details-row[data-eval-id="${evalId}"]`);
    const icon = button.querySelector('i');
    
    if (detailsRow.classList.contains('expanded')) {
        detailsRow.classList.remove('expanded');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-right');
    } else {
        detailsRow.classList.add('expanded');
        icon.classList.remove('bi-chevron-right');
        icon.classList.add('bi-chevron-down');
    }
}

// ============================================
// EXPORTAÇÃO
// ============================================
function exportEvaluations() {
    const rows = document.querySelectorAll('.eval-row');
    let csv = 'Mês Referência,Data Avaliação,Avaliador,Score (%),Nota,Status\n';
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const monthRef = row.querySelector('.month-display').textContent.trim();
            const evalDate = row.querySelector('.date-display').textContent.trim();
            const evaluator = row.querySelector('.evaluator-name').textContent.trim();
            const score = row.querySelector('.score-text-inline').textContent.trim().replace('%', '');
            const rating = row.querySelector('.rating-number-inline').textContent.trim().replace('/10', '');
            const statusBadge = row.querySelector('.status-badge-inline');
            const status = statusBadge ? statusBadge.textContent.trim() : '-';
            
            csv += `"${monthRef}","${evalDate}","${evaluator}","${score}","${rating}","${status}"\n`;
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `avaliacoes_{{ supplier.company_name|replace(' ', '_') }}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}
</script>
{% endblock %}
