{% extends "navbar.html" %}
{% block title %}Registros de Plantão{% endblock %}

{% block content %}
<div class="forms-page">
    <div class="container-fluid py-4">
        <div class="forms-header">
            <div class="forms-header-content">
                <div class="forms-title-section">
                    <h1 class="forms-title">
                        <i class="bi bi-arrow-left-right"></i>
                        Registros de Plantão
                    </h1>
                    <p class="forms-subtitle">Gerencie os registros das passagens de plantão</p>
                </div>
            </div>
        </div>  
    {% include 'partials/_flash_messages.html' %}
    {% if messages %}
    <div class="row mb-3">
        <div class="col-12">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <div class="forms-card forms-filters-card">
            <div class="forms-card-body forms-filters-body">
            <form method="GET" action="{{ url_for('form.forms') }}" class="forms-filters-form">
                <div class="forms-filters-container">
                    <div class="forms-filters-row">
                        <div class="forms-filter-item">
                            <div class="forms-input-group forms-input-compact">
                                <span class="forms-input-icon">
                                    <i class="bi bi-person-search"></i>
                                </span>
                                <input type="text" name="name" id="filtro_nome" class="forms-input forms-input-sm"
                                    placeholder="Nome do responsável" value="{{ request.args.get('name', '') }}">
                            </div>
                        </div>
                        
                        <div class="forms-filter-item">
                            <div class="forms-input-group forms-input-compact">
                                <span class="forms-input-icon">
                                    <i class="bi bi-hospital"></i>
                                </span>
                                <select name="sector_filtro" id="filtro_setor" class="forms-select forms-input-sm">
                                <option value="">Todos os setores</option>
                                {% for setor_opcao in
                                ['Posto PS', 'Posto Clínico', 'Posto Cirúrgico', 'Centro Cirúrgico','Emergência'] %}
                                <option value="{{ setor_opcao }}" {% if request.args.get('sector_filtro')==setor_opcao
                                    %}selected{% endif %}>
                                    {{ setor_opcao }}
                                </option>
                                {% endfor %}
                            </select>
                            </div>
                        </div>
                        
                        <div class="forms-filter-item">
                            <div class="forms-input-group forms-input-compact">
                                <span class="forms-input-icon">
                                    <i class="bi bi-calendar-date"></i>
                                </span>
                                <input type="date" name="data_inicio" id="filtro_data_inicio"
                                    class="forms-input forms-input-sm" value="{{ data_inicio_atual or '' }}"
                                    title="Data inicial">
                            </div>
                        </div>
                        
                        <div class="forms-filter-item">
                            <div class="forms-input-group forms-input-compact">
                                <span class="forms-input-icon">
                                    <i class="bi bi-calendar-date"></i>
                                </span>
                                <input type="date" name="data_fim" id="filtro_data_fim" class="forms-input forms-input-sm"
                                    value="{{ data_fim_atual or '' }}" title="Data final">
                            </div>
                        </div>

                        <div class="forms-filter-actions">
                            <button type="submit" class="forms-btn forms-btn-primary forms-btn-sm">
                                <i class="bi bi-search"></i>
                                Filtrar
                            </button>
                            <a href="{{ url_for('form.forms') }}" class="forms-btn forms-btn-secondary forms-btn-sm">
                                <i class="bi bi-eraser"></i>
                                Limpar
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="forms-card">
            <div class="forms-card-header">
                <div class="forms-card-title-section">
                    <h5 class="forms-card-title">
                        <i class="bi bi-list-stars"></i>
                        Lista de Registros
                    </h5>
                    {% if forms.items is defined and forms.total is defined %}
                    <span class="forms-card-subtitle">Exibindo {{ forms.items|length }} de {{ forms.total }} resultados</span>
                    {% elif forms|length > 0 %}
                    <span class="forms-card-subtitle">Exibindo {{ forms|length }} resultado(s)</span>
                    {% endif %}
                </div>
            </div>
            <div class="forms-card-body forms-table-container">
            <div class="forms-table-responsive">
                    <table class="forms-table">
                        <thead class="forms-table-head">
                            <tr>
                                <th class="forms-table-header">Responsável</th>
                                <th class="forms-table-header forms-table-center">Setor</th>
                                <th class="forms-table-header forms-table-center">Data Registro</th>
                                <th class="forms-table-header forms-table-center forms-table-actions">Ações</th>
                            </tr>
                        </thead>
                    <tbody class="forms-table-body">
                            {% set forms_to_iterate = forms.items if forms.items is defined else forms %}
                            {% for f in forms_to_iterate %}
                            <tr class="forms-table-row">
                                <td class="forms-table-cell">
                                    <div class="forms-user-info">
                                        <a href="{{ url_for('form.details_form', form_id=f.id) }}" class="forms-user-name">
                                            {{ f.worker.name | truncate(35, False) }}
                                        </a>
                                        <span class="forms-user-username">{{ f.worker.username | truncate(35, False) }}</span>
                                    </div>
                                </td>
                                <td class="forms-table-cell forms-table-center">
                                    <span class="forms-sector-badge">{{ f.sector | default('N/A') }}</span>
                                </td>
                                <td class="forms-table-cell forms-table-center">
                                    <div class="forms-date-info">
                                        <span class="forms-date">{{ f.date_registry | format_date_short if f.date_registry else 'N/A' }}</span>
                                        <span class="forms-time">{{ f.date_registry | format_time if f.date_registry else 'N/A' }}</span>
                                    </div>
                                </td>
                                <td class="forms-table-cell forms-table-center">
                                    <div class="forms-action-buttons">
                                        <a href="{{ url_for('form.details_form', form_id=f.id) }}" class="forms-action-btn forms-action-view" title="Ver Detalhes">
                                            <i class="bi bi-eye-fill"></i>
                                        </a>
                                        {% if 'ALTERAR_STATUS' in session.get('perfil', []) or 'ADMIN' in session.get('perfil', []) %}
                                        <button type="button" class="forms-action-btn forms-action-edit" title="Alterar Status" 
                                            data-bs-toggle="modal" data-bs-target="#alterarStatusFormModal" 
                                            data-form-id="{{ f.id }}" data-current-status="{{ f.status }}">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr class="forms-table-row">
                                <td colspan="4" class="forms-table-cell">
                                    <div class="forms-empty-state">
                                        <div class="forms-empty-icon">
                                            <i class="bi bi-inbox"></i>
                                        </div>
                                        <p class="forms-empty-text">Nenhum Registro encontrado.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% if pagination %}
        <nav aria-label="Navegação de usuários">
            <ul class="pagination justify-content-center mt-4">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('form.forms', page=pagination.prev_num) }}">Anterior</a>
                </li>
                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if p %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('form.forms', page=p) }}">{{ p }}</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('form.forms', page=pagination.next_num) }}">Próxima</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}