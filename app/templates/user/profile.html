{% extends "navbar.html" %}

{% block title %}Meu Perfil | SISPLA{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4 overflow-hidden" style="border-radius: 16px;">
                <div class="card-header border-0 bg-white p-0 position-relative"
                    style="height: 120px; background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);">
                </div>
                <div class="card-body p-4 pt-0 position-relative">
                    <div class="d-flex justify-content-between align-items-end mb-4" style="margin-top: -60px;">
                        <div class="d-flex align-items-end">
                            <div class="bg-white p-1 rounded-circle shadow-sm">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                                    style="width: 120px; height: 120px; border: 4px solid #fff;">
                                    <i class="fas fa-user-circle text-secondary" style="font-size: 80px;"></i>
                                </div>
                            </div>
                            <div class="ms-3 mb-2">
                                <h2 class="fw-bold mb-0 text-dark">{{ current_user.name }}</h2>
                                <p class="text-muted mb-0">{{ current_user.job_title or 'Colaborador' }}</p>
                            </div>
                        </div>
                        <div class="mb-2 d-none d-md-block">
                            <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">
                                <i class="fas fa-id-badge me-2"></i>{{ current_user.username }}
                            </span>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-3 h-100">
                                <small class="text-muted d-block mb-1 text-uppercase fw-bold"
                                    style="font-size: 0.75rem;">Email Corporativo</small>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope text-primary me-2"></i>
                                    <span class="fw-medium text-dark">{{ current_user.email }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-3 h-100">
                                <small class="text-muted d-block mb-1 text-uppercase fw-bold"
                                    style="font-size: 0.75rem;">Setor / Departamento</small>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    <span class="fw-medium text-dark">
                                        {% for role in current_user.roles %}
                                        {{ role.name }}{% if not loop.last %}, {% endif %}
                                        {% else %}
                                        Não definido
                                        {% endfor %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                <div class="card-header bg-white border-0 p-4 pb-0">
                    <h5 class="fw-bold mb-0"><i class="bi bi-shield-lock me-2 text-primary"></i>Segurança da Conta</h5>
                </div>
                <div class="card-body p-4">

                    <div
                        class="d-flex align-items-center justify-content-between p-3 rounded-3 {{ 'bg-success-subtle' if current_user.totp_secret else 'bg-light' }}">
                        <div class="d-flex align-items-center">
                            <div
                                class="rounded-circle p-3 {{ 'bg-success text-white' if current_user.totp_secret else 'bg-white text-secondary shadow-sm' }} me-3">
                                <i class="bi bi-phone-vibrate fs-4"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-1">Autenticação de Dois Fatores (2FA)</h6>
                                <p
                                    class="mb-0 small {{ 'text-success-emphasis' if current_user.totp_secret else 'text-muted' }}">
                                    {% if current_user.totp_secret %}
                                    Sua conta está protegida com uma camada extra de segurança.
                                    {% else %}
                                    Adicione uma camada extra de segurança à sua conta.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div>
                            {% if current_user.totp_secret %}
                            <button type="button" class="btn btn-outline-danger btn-sm fw-bold" data-bs-toggle="modal"
                                data-bs-target="#disable2FAModal">
                                Desativar
                            </button>
                            {% else %}
                            <form action="{{ url_for('user.setup_2fa') }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-primary btn-sm fw-bold px-4">
                                    Ativar Agora
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-4 text-muted opacity-25">

                    <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded-3">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-white text-secondary shadow-sm me-3">
                                <i class="bi bi-key fs-4"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-1">Alterar Senha</h6>
                                <p class="mb-0 small text-muted">Atualize sua senha periodicamente para manter-se
                                    seguro.</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm fw-bold" type="button" data-bs-toggle="modal"
                            data-bs-target="#modalTrocarSenhaBase">
                            Alterar
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

{% from "components/modals.html" import confirm_action_modal %}

{{ confirm_action_modal(
    'disable2FAModal',
    'Desativar 2FA?',
    'Sua conta ficará menos segura sem a autenticação de dois fatores. Tem certeza que deseja continuar?',
    url_for('user.disable_2fa'),
    'Sim, Desativar'
) }}
{% endblock %}