
{% extends "navbar.html" %}
{% block title %}Repositório: {{ repository.name }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4 repository-page">
    <div class="breadcrumb-section mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb modern-breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('repository.repository_list_page') }}">
                        <i class="bi bi-hdd-stack-fill me-1"></i>Repositórios
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('repository.repository_detail_page', repo_id=repository.id) }}">
                        <i class="bi bi-box-seam me-1"></i>{{ repository.name }}
                    </a>
                </li>
                {% for folder in breadcrumbs %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('repository.repository_detail_page', repo_id=repository.id, folder_id=folder.id) }}">
                        {{ folder.name }}
                    </a>
                </li>
                {% endfor %}
                {% if current_folder %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="bi bi-folder-fill me-1"></i>{{ current_folder.name }}
                </li>
                {% endif %}
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div class="page-header">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper me-3">
                        <i class="bi bi-{{ 'folder-fill' if current_folder else 'box-seam' }}"></i>
                    </div>
                    <div>
                        <h1 class="page-title mb-1">{{ current_folder.name if current_folder else repository.name }}</h1>
                        <p class="page-subtitle mb-0">
                            {% if current_folder %}
                            Pasta dentro de {{ repository.name }}
                            {% else %}
                            {{ repository.description or 'Repositório de documentos' }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary btn-modern" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i>
                    Fazer Upload
                </button>
            </div>
        </div>
    </div>

    {% include 'partials/_flash_messages.html' %}

    <div class="form-card file-explorer-card">
        <div class="form-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="form-title mb-0">
                    <i class="bi bi-files me-2"></i>
                    Explorador de Arquivos
                </h3>
                <div class="search-filter-container" style="min-width: 250px;">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0" style="border-color: #e0e0e0;">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input 
                            type="text" 
                            id="file-filter-input" 
                            class="form-control border-start-0" 
                            placeholder="Filtrar arquivos/pastas..."
                            style="border-color: #e0e0e0;"
                        >
                        <button 
                            class="btn btn-outline-secondary" 
                            id="clear-filter-btn" 
                            type="button"
                            style="display: none;"
                        >
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <span id="filter-result-count"></span>
                    </small>
                </div>
            </div>
        </div>
        <div class="form-card-body">
            {% if not folders and not files %}
            <div class="empty-folder-container">
                <div class="empty-folder-content">
                    <div class="empty-icon">
                        <i class="bi bi-folder2-open"></i>
                    </div>
                    <h4 class="empty-title">Pasta Vazia</h4>
                    <p class="empty-description">
                        Clique com o botão direito para criar uma nova pasta ou use o botão "Fazer Upload" para adicionar arquivos.
                    </p>
                </div>
            </div>
            {% else %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 file-explorer-table">
                    <thead class="table-header">
                        <tr>
                            <th scope="col" class="ps-4" style="width: 50%;">Nome</th>
                            <th scope="col" style="width: 25%;">Data de Modificação</th>
                            <th scope="col" style="width: 15%;">Tipo</th>
                            <th scope="col" class="text-end pe-4" style="width: 10%;">Tamanho</th>
                        </tr>
                    </thead>
                    <tbody id="file-list-body">
                        {% for folder in folders %}
                        <tr class="file-row is-folder" draggable="true" data-file-id="{{ folder.id }}"
                            data-file-name="{{ folder.name }}" data-file-ext="folder"
                            data-file-date="{{ folder.date_uploaded.isoformat() }}" tabindex="0">
                            <td class="ps-4">
                                <a href="{{ url_for('repository.repository_detail_page', repo_id=repository.id, folder_id=folder.id) }}"
                                   class="file-link">
                                    <div class="file-item">
                                        <div class="file-icon folder-icon">
                                            <i class="bi bi-folder-fill"></i>
                                        </div>
                                        <span class="file-name">{{ folder.name }}</span>
                                    </div>
                                </a>
                            </td>
                            <td class="file-date">{{ folder.date_uploaded | format_date_time }}</td>
                            <td class="file-type-text">Pasta de arquivos</td>
                            <td class="text-end pe-4 file-size-text">--</td>
                        </tr>
                        {% endfor %}
                        {% for file in files %}
                        <tr class="file-row" draggable="true" data-file-id="{{ file.id }}"
                            data-file-name="{{ file.name }}" data-file-ext="{{ file.extension }}"
                            data-file-size="{{ file.size|int }}" data-file-date="{{ file.date_uploaded.isoformat() }}"
                            tabindex="0">
                            <td class="ps-4">
                                <div class="file-item">
                                    <div class="file-icon">
                                        <i class="bi"></i>
                                    </div>
                                    <span class="file-name">{{ file.name }}</span>
                                </div>
                            </td>
                            <td class="file-date">{{ file.date_uploaded | format_date_time }}</td>
                            <td class="file-type-text">
                                {{ file.extension|replace('.', '')|upper if file.extension else 'Arquivo' }}
                            </td>
                            <td class="text-end pe-4 file-size-text">
                                {% if file.size > 1024*1024 %}{{ "%.1f"|format(file.size / (1024*1024)) }} MB
                                {% elif file.size > 1024 %}{{ "%.0f"|format(file.size / 1024) }} KB
                                {% else %}{{ file.size or 0 }} B{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<ul class="dropdown-menu modern-context-menu" id="context-menu">
    <li><a class="dropdown-item" href="#" id="context-create-folder">
        <i class="bi bi-folder-plus me-2"></i>Criar Nova Pasta
    </a></li>
    <li><hr class="dropdown-divider" id="context-divider-1"></li>
    <li><a class="dropdown-item" href="#" id="context-preview">
        <i class="bi bi-eye me-2"></i>Visualizar
    </a></li>
    <li><a class="dropdown-item" href="#" id="context-rename">
        <i class="bi bi-pencil-square me-2"></i>Renomear
    </a></li>
    <li><a class="dropdown-item" href="#" id="context-download">
        <i class="bi bi-download me-2"></i>Baixar
    </a></li>
    <li><a class="dropdown-item" href="#" id="context-move">
        <i class="bi bi-arrow-right-circle me-2"></i>Mover
    </a></li>
    <li><hr class="dropdown-divider" id="context-divider-2"></li>
    <li><a class="dropdown-item text-danger" href="#" id="context-delete">
        <i class="bi bi-trash3 me-2"></i>Excluir
    </a></li>
</ul>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="uploadModalLabel">
                    <i class="bi bi-cloud-arrow-up-fill me-2 text-primary"></i>
                    Fazer Upload de Arquivos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="upload-form" method="POST"
                      action="{{ url_for('repository.upload_file', repo_id=repository.id) }}"
                      enctype="multipart/form-data">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}">

                    <div id="upload-zone" class="upload-zone">
                        <div class="upload-icon">
                            <i class="bi bi-cloud-upload"></i>
                        </div>
                        <h5 class="upload-title">Arraste e solte arquivos aqui</h5>
                        <p class="upload-subtitle">ou</p>
                        <button type="button" id="browse-btn" class="btn btn-outline-primary">
                            <i class="bi bi-folder2-open me-2"></i>Selecione os Arquivos
                        </button>
                        <input type="file" name="file" id="file-input" class="d-none" required multiple>
                    </div>

                    <div id="file-preview-list" class="mt-4 d-none">
                        <h6 class="mb-3 fw-bold">Arquivos a serem enviados:</h6>
                        <div class="list-group preview-list"></div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Cancelar
                        </button>
                        <button type="submit" id="submit-btn" class="btn btn-primary" disabled>
                            <i class="bi bi-check-circle me-2"></i>Enviar Arquivos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="previewModalLabel">
                    <i class="bi bi-eye me-2 text-primary"></i>
                    Visualizando Arquivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0" id="preview-content"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1" aria-labelledby="moveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="moveModalLabel">
                    <i class="bi bi-arrow-right-circle me-2 text-primary"></i>
                    Mover Item
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Selecione a pasta de destino para: <strong id="move-item-name"></strong></p>
                <select class="form-select modern-select" id="folder-destination-select">
                    <option value="">-- Raiz do Repositório --</option>
                    {% for folder_option in all_folders %}
                    <option value="{{ folder_option.id }}">{{ folder_option.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="file-to-move-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="execute-move-btn">
                    <i class="bi bi-check-circle me-2"></i>Mover
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ====================================================================
    //                         VARIÁVEIS GLOBAIS
    // ====================================================================
    const tableBody = document.getElementById('file-list-body');
    const contextMenu = document.getElementById('context-menu');
    const repoId = {{ repository.id | tojson }};
    const parentFolderId = {{ current_folder.id | tojson if current_folder else 'null' }};
    const csrfToken = '{{ csrf_token() }}';
    let selectedRow = null;
    let moveModalInstance = null;

    const iconMap = { 
        '.pdf': 'bi-file-earmark-pdf-fill text-danger', 
        '.doc': 'bi-file-earmark-word-fill text-primary', 
        '.docx': 'bi-file-earmark-word-fill text-primary', 
        '.xls': 'bi-file-earmark-excel-fill text-success', 
        '.xlsx': 'bi-file-earmark-excel-fill text-success', 
        '.zip': 'bi-file-earmark-zip-fill text-secondary', 
        '.rar': 'bi-file-earmark-zip-fill text-secondary',
        '.7z': 'bi-file-earmark-zip-fill text-secondary',
        '.jpg': 'bi-file-earmark-image-fill text-info', 
        '.jpeg': 'bi-file-earmark-image-fill text-info', 
        '.png': 'bi-file-earmark-image-fill text-info',
        '.gif': 'bi-file-earmark-image-fill text-info',
        '.svg': 'bi-file-earmark-image-fill text-info',
        '.txt': 'bi-file-earmark-text-fill text-muted',
        '.md': 'bi-file-earmark-text-fill text-muted',
        '.html': 'bi-file-earmark-code-fill text-warning',
        '.css': 'bi-file-earmark-code-fill text-warning',
        '.js': 'bi-file-earmark-code-fill text-warning',
        '.py': 'bi-file-earmark-code-fill text-warning',
        '.json': 'bi-file-earmark-code-fill text-warning'
    };
    const defaultIcon = 'bi-file-earmark-fill text-secondary';

    // ====================================================================
    //                         FUNÇÕES UTILITÁRIAS
    // ====================================================================
    
    function applyFileIcons() {
        if (!tableBody) return;
        tableBody.querySelectorAll('.file-row:not(.is-folder)').forEach(row => {
            const iconClass = iconMap[row.dataset.fileExt] || defaultIcon;
            const iconElement = row.querySelector('.file-icon i');
            if (iconElement) {
                iconElement.className = `bi ${iconClass}`;
            }
        });
    }

    function selectRow(row) {
        if (selectedRow) {
            selectedRow.classList.remove('is-selected');
        }
        if (row) {
            row.classList.add('is-selected');
            selectedRow = row;
        } else {
            selectedRow = null;
        }
    }

    function updateContextMenuActions(row) {
        const isFile = row && !row.classList.contains('is-folder');
        const isFolder = row && row.classList.contains('is-folder');
        const isItemSelected = isFile || isFolder;

        document.getElementById('context-preview').style.display = isFile ? 'block' : 'none';
        document.getElementById('context-download').style.display = isFile ? 'block' : 'none';
        document.getElementById('context-rename').style.display = isItemSelected ? 'block' : 'none';
        document.getElementById('context-move').style.display = isItemSelected ? 'block' : 'none';
        document.getElementById('context-delete').style.display = isItemSelected ? 'block' : 'none';
        document.getElementById('context-divider-1').style.display = isItemSelected ? 'block' : 'none';
        document.getElementById('context-divider-2').style.display = isItemSelected ? 'block' : 'none';
        document.getElementById('context-create-folder').style.display = 'block';
        
        if (row) {
            const fileId = row.dataset.fileId;
            
            document.getElementById('context-rename').onclick = (e) => {
                e.preventDefault();
                renameItemFromRow(row);
            };
            
            document.getElementById('context-delete').onclick = (e) => {
                e.preventDefault();
                deleteItemFromRow(row);
            };
            
            document.getElementById('context-move').onclick = (e) => {
                e.preventDefault();
                openMoveModal(row);
            };
            
            if (isFile) {
                document.getElementById('context-preview').onclick = (e) => {
                    e.preventDefault();
                    previewFileFromRow(row);
                };
                
                const downloadLink = document.getElementById('context-download');
                downloadLink.href = `/file/download/${fileId}`;
                downloadLink.onclick = null;
            }
        }
    }

    // ====================================================================
    //                      EVENT LISTENERS PRINCIPAIS
    // ====================================================================

    const fileExplorerCard = document.querySelector('.file-explorer-card');
    if (fileExplorerCard) {
        fileExplorerCard.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = e.target.closest('.file-row');
            selectRow(row);
            updateContextMenuActions(row);
            
            contextMenu.style.position = 'fixed';
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.zIndex = '9999';
            
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = `${e.clientX - rect.width}px`;
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = `${e.clientY - rect.height}px`;
            }
        });
    }

    const emptyFolderContainer = document.querySelector('.empty-folder-container');
    if (emptyFolderContainer) {
        emptyFolderContainer.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            selectRow(null);
            updateContextMenuActions(null);
            
            contextMenu.style.position = 'fixed';
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.zIndex = '9999';
            
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = `${e.clientX - rect.width}px`;
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = `${e.clientY - rect.height}px`;
            }
        });
    }

    if (tableBody) {
        tableBody.addEventListener('dblclick', e => {
            const row = e.target.closest('.file-row');
            if (!row) return;
            
            if (row.classList.contains('is-folder')) {
                const link = row.querySelector('a');
                if (link) link.click();
            } else {
                previewFileFromRow(row);
            }
        });
    }

    document.addEventListener('click', e => {
        if (!contextMenu.contains(e.target)) {
            contextMenu.style.display = 'none';
        }
        
        if (tableBody && !tableBody.parentElement.contains(e.target)) {
            selectRow(null);
        }
    });

    // ====================================================================
    //                       FUNCIONALIDADES DO MENU
    // ====================================================================

    document.getElementById('context-create-folder').addEventListener('click', function(e) {
        e.preventDefault();
        createNewFolder();
    });

    function createNewFolder() {
        const folderName = prompt("Digite o nome da nova pasta:");
        if (folderName && folderName.trim() !== '') {
            fetch(`/repository/${repoId}/create_folder`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    folder_name: folderName.trim(),
                    parent_id: parentFolderId
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    throw new Error(data.error || 'Ocorreu um erro desconhecido.');
                }
            })
            .catch(error => {
                alert(`Erro ao criar pasta: ${error.error || error.message}`);
            });
        }
    }

    function previewFileFromRow(row) {
        const fileId = row.dataset.fileId;
        const extension = row.dataset.fileExt;
        const fileName = row.dataset.fileName;
        const fileUrl = `/file/view/${fileId}`;
        
        const previewContent = document.getElementById('preview-content');
        const previewModalLabel = document.getElementById('previewModalLabel');
        
        previewModalLabel.innerHTML = `<i class="bi bi-eye me-2 text-primary"></i>Visualizando: ${fileName}`;
        
        let content = '';
        const supportedImageExt = ['.jpg', '.jpeg', '.png', '.gif', '.svg'];
        
        if (supportedImageExt.includes(extension)) {
            content = `<img src="${fileUrl}" class="img-fluid" alt="Preview" style="max-height: 75vh; object-fit: contain;">`;
        } else if (extension === '.pdf') {
            content = `<iframe src="${fileUrl}" style="width:100%; height:80vh;" frameborder="0"></iframe>`;
        } else {
            const downloadUrl = `/file/download/${fileId}`;
            content = `
                <div class="p-5 text-center">
                    <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                    <p class="mt-4 fs-5">Pré-visualização não suportada para este tipo de arquivo.</p>
                    <a href="${downloadUrl}" class="btn btn-primary mt-2">
                        <i class="bi bi-download me-2"></i>Baixar Arquivo
                    </a>
                </div>
            `;
        }
        
        previewContent.innerHTML = content;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    function renameItemFromRow(rowElement) {
        const fileId = rowElement.dataset.fileId;
        const currentName = rowElement.dataset.fileName;
        const fileNameSpan = rowElement.querySelector('.file-name');
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control modern-input';
        input.style.width = '70%';
        input.value = currentName;
        
        fileNameSpan.style.display = 'none';
        fileNameSpan.parentNode.insertBefore(input, fileNameSpan.nextSibling);
        input.focus();
        input.select();
        
        const cleanup = (name) => {
            input.remove();
            fileNameSpan.textContent = name;
            fileNameSpan.style.display = '';
        };
        
        const saveChanges = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentName) {
                fetch(`/file/rename/${fileId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ new_name: newName })
                })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        cleanup(data.new_name);
                        rowElement.dataset.fileName = data.new_name;
                    } else {
                        alert(`Erro: ${data.error}`);
                        cleanup(currentName);
                    }
                })
                .catch(error => {
                    alert(`Erro: ${error.message}`);
                    cleanup(currentName);
                });
            } else {
                cleanup(currentName);
            }
        };
        
        input.addEventListener('blur', saveChanges);
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                input.blur(); 
            } else if (e.key === 'Escape') { 
                cleanup(currentName); 
            }
        });
    }

    function deleteItemFromRow(rowElement) {
        const fileId = rowElement.dataset.fileId;
        const fileName = rowElement.dataset.fileName;
        
        if (confirm(`Tem certeza que deseja excluir '${fileName}'?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/file/delete/${fileId}`;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // ====================================================================
    //                      MODAL DE MOVER ARQUIVO
    // ====================================================================

    function openMoveModal(row) {
        const fileId = row.dataset.fileId;
        const fileName = row.dataset.fileName;
        
        document.getElementById('file-to-move-id').value = fileId;
        document.getElementById('move-item-name').textContent = fileName;
        
        if (!moveModalInstance) {
            moveModalInstance = new bootstrap.Modal(document.getElementById('moveModal'));
        }
        moveModalInstance.show();
    }

    document.getElementById('execute-move-btn').addEventListener('click', function() {
        const fileId = document.getElementById('file-to-move-id').value;
        const targetFolderId = document.getElementById('folder-destination-select').value || null;
        
        fetch('/file/move', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                file_id: parseInt(fileId), 
                target_folder_id: targetFolderId ? parseInt(targetFolderId) : null 
            })
        })
        .then(res => res.json().then(data => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
            if (ok && data.success) {
                window.location.reload();
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        })
        .catch(error => {
            alert(`Erro ao mover item: ${error.message}`);
        })
        .finally(() => {
            if (moveModalInstance) {
                moveModalInstance.hide();
            }
        });
    });

    // ====================================================================
    //                      DRAG & DROP
    // ====================================================================

    let draggedItem = null;
    
    if (tableBody) {
        tableBody.addEventListener('dragstart', e => {
            const row = e.target.closest('.file-row');
            if (row) {
                draggedItem = row;
                setTimeout(() => row.classList.add('is-dragging'), 0);
            }
        });

        tableBody.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.classList.remove('is-dragging');
            }
        });

        tableBody.addEventListener('dragover', e => {
            e.preventDefault();
            const targetRow = e.target.closest('.is-folder');
            
            document.querySelectorAll('.is-folder.drag-over').forEach(folder => 
                folder.classList.remove('drag-over')
            );
            
            if (targetRow && targetRow !== draggedItem) {
                targetRow.classList.add('drag-over');
            }
        });

        tableBody.addEventListener('dragleave', e => {
            if (!tableBody.contains(e.relatedTarget)) {
                document.querySelectorAll('.is-folder.drag-over').forEach(folder => 
                    folder.classList.remove('drag-over')
                );
            }
        });

        tableBody.addEventListener('drop', e => {
            e.preventDefault();
            const targetRow = e.target.closest('.is-folder');
            
            document.querySelectorAll('.is-folder.drag-over').forEach(folder => 
                folder.classList.remove('drag-over')
            );

            if (targetRow && draggedItem && targetRow !== draggedItem) {
                fetch('/file/move', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ 
                        file_id: parseInt(draggedItem.dataset.fileId), 
                        target_folder_id: parseInt(targetRow.dataset.fileId) 
                    })
                })
                .then(res => {
                    if (res.ok) {
                        draggedItem.remove();
                    } else {
                        return res.json().then(data => {
                            throw new Error(data.error || 'Erro ao mover');
                        });
                    }
                })
                .catch(error => {
                    alert(`Erro ao mover: ${error.message}`);
                });
            }
        });
    }

    const uploadModal = document.getElementById('uploadModal');
    if (uploadModal) {
        const uploadZone = uploadModal.querySelector('#upload-zone');
        const fileInput = uploadModal.querySelector('#file-input');
        const browseBtn = uploadModal.querySelector('#browse-btn');
        const previewListContainer = uploadModal.querySelector('#file-preview-list');
        const previewList = previewListContainer.querySelector('.preview-list');
        const submitBtn = uploadModal.querySelector('#submit-btn');

        browseBtn.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('click', (e) => {
            if (e.target.id !== 'browse-btn') {
                fileInput.click();
            }
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.add('is-dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.remove('is-dragover');
            }, false);
        });

        uploadZone.addEventListener('drop', e => {
            fileInput.files = e.dataTransfer.files;
            handleFiles(fileInput.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            previewList.innerHTML = '';
            
            if (files.length > 0) {
                previewListContainer.classList.remove('d-none');
                submitBtn.disabled = false;

                Array.from(files).forEach(file => {
                    const extension = `.${file.name.split('.').pop().toLowerCase()}`;
                    const iconClass = iconMap[extension] || defaultIcon;
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    
                    const previewItem = `
                        <div class="list-group-item d-flex align-items-center file-preview-item">
                            <i class="bi ${iconClass} fs-4 me-3"></i>
                            <span class="flex-grow-1 text-truncate file-preview-name">${file.name}</span>
                            <span class="text-muted small ms-3 file-preview-size">${fileSizeMB} MB</span>
                        </div>
                    `;
                    previewList.innerHTML += previewItem;
                });
            } else {
                previewListContainer.classList.add('d-none');
                submitBtn.disabled = true;
            }
        }
    }

    applyFileIcons();

    const filterInput = document.getElementById('file-filter-input');
    const clearFilterBtn = document.getElementById('clear-filter-btn');
    const filterResultCount = document.getElementById('filter-result-count');
    let allRepositoryItems = [];
    let isLoadingAllItems = false;

    async function loadAllRepositoryItems() {
        if (isLoadingAllItems) return;
        isLoadingAllItems = true;
        
        try {
            const response = await fetch(`/repository/${repoId}/all-files`);
            if (!response.ok) throw new Error('Erro ao carregar arquivos');
            
            const data = await response.json();
            allRepositoryItems = data.items || [];
            console.log(`Carregados ${allRepositoryItems.length} itens do repositório`);
        } catch (error) {
            console.error('Erro ao carregar todos os itens:', error);
            allRepositoryItems = [];
        }
    }

    loadAllRepositoryItems();

    if (filterInput) {
        filterInput.addEventListener('input', function() {
            const filterTerm = this.value.toLowerCase().trim();
            
            if (filterTerm) {
                clearFilterBtn.style.display = 'block';
                globalSearchFilter(filterTerm);
            } else {
                clearFilterBtn.style.display = 'none';
                showAllRows();
                updateResultCount();
            }
        });
    }

    if (clearFilterBtn) {
        clearFilterBtn.addEventListener('click', function() {
            filterInput.value = '';
            clearFilterBtn.style.display = 'none';
            showAllRows();
            updateResultCount();
            filterInput.focus();
        });
    }

    function globalSearchFilter(term) {
        if (!tableBody || allRepositoryItems.length === 0) {
            filterRows(term);
            return;
        }

        const filteredItems = allRepositoryItems.filter(item => 
            item.name.toLowerCase().includes(term)
        );

        tableBody.querySelectorAll('.file-row').forEach(row => {
            row.style.display = 'none';
        });

        hideNoResultsMessage();

        let visibleCount = 0;
        const visibleInCurrentFolder = [];
        const inOtherFolders = [];

        filteredItems.forEach(item => {
            const row = tableBody.querySelector(`[data-file-id="${item.id}"]`);
            if (row) {
                row.style.display = '';
                visibleCount++;
                visibleInCurrentFolder.push(item);
            } else {
                inOtherFolders.push(item);
            }
        });

        if (inOtherFolders.length > 0) {
            inOtherFolders.forEach(item => {
                createDynamicRow(item);
            });
            visibleCount += inOtherFolders.length;
        }

        updateResultCount(filteredItems.length, allRepositoryItems.length);

        if (filteredItems.length === 0) {
            showGlobalNoResultsMessage(term);
        }
    }

    function createDynamicRow(item) {
        if (!tableBody) return;

        const row = document.createElement('tr');
        row.className = `file-row ${item.type === 'folder' ? 'is-folder' : ''}`;
        row.dataset.fileId = item.id;
        row.dataset.fileName = item.name;
        row.dataset.fileExt = item.extension || 'folder';
        row.dataset.dynamic = 'true';
        row.draggable = true;
        row.tabIndex = 0;

        let icon = '';
        let type = '';
        let size = '--';

        if (item.type === 'folder') {
            icon = '<i class="bi bi-folder-fill"></i>';
            type = 'Pasta de arquivos';
        } else {
            icon = '<i class="bi"></i>';
            type = (item.extension || '').replace('.', '').toUpperCase() || 'Arquivo';
        }

        row.innerHTML = `
            <td class="ps-4">
                <div class="file-item">
                    <div class="file-icon ${item.type === 'folder' ? 'folder-icon' : ''}">
                        ${icon}
                    </div>
                    <span class="file-name">${item.name}</span>
                    <small class="text-muted ms-2" style="font-size: 0.75rem;">(em outra pasta)</small>
                </div>
            </td>
            <td class="file-date">${item.date ? new Date(item.date).toLocaleString('pt-BR') : '-'}</td>
            <td class="file-type-text">${type}</td>
            <td class="text-end pe-4 file-size-text">${size}</td>
        `;

        tableBody.appendChild(row);

        // Aplicar ícone se for arquivo
        if (item.type === 'file') {
            const iconClass = iconMap[item.extension] || defaultIcon;
            const iconElement = row.querySelector('.file-icon i');
            if (iconElement) {
                iconElement.className = `bi ${iconClass}`;
            }
        }
    }

    function filterRows(term) {
        if (!tableBody) return;

        let visibleCount = 0;
        const rows = tableBody.querySelectorAll('.file-row');

        rows.forEach(row => {
            const fileName = row.dataset.fileName ? row.dataset.fileName.toLowerCase() : '';
            
            if (fileName.includes(term)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        updateResultCount(visibleCount, rows.length);
        
        if (visibleCount === 0) {
            showNoResultsMessage();
        } else {
            hideNoResultsMessage();
        }
    }

    function showAllRows() {
        if (!tableBody) return;
        tableBody.querySelectorAll('.file-row').forEach(row => {
            row.style.display = '';
        });
        // Remover linhas dinâmicas
        tableBody.querySelectorAll('.file-row[data-dynamic="true"]').forEach(row => {
            row.remove();
        });
        hideNoResultsMessage();
    }

    function updateResultCount(visibleCount, totalCount) {
        if (!filterResultCount) return;

        if (visibleCount === undefined || totalCount === undefined) {
            // Modo sem filtro
            const totalRows = tableBody ? tableBody.querySelectorAll('.file-row').length : 0;
            if (totalRows > 0) {
                filterResultCount.textContent = `${totalRows} ${totalRows === 1 ? 'item' : 'itens'}`;
            } else {
                filterResultCount.textContent = '';
            }
        } else {
            // Modo com filtro
            if (visibleCount === 0) {
                filterResultCount.textContent = 'Nenhum resultado encontrado em todo o repositório';
                filterResultCount.classList.add('text-danger');
            } else {
                filterResultCount.textContent = `${visibleCount} de ${totalCount} ${totalCount === 1 ? 'item' : 'itens'} encontrado(s) em todo o repositório`;
                filterResultCount.classList.remove('text-danger');
            }
        }
    }

    function showNoResultsMessage() {
        let noResultsRow = document.getElementById('no-results-row');
        
        if (!noResultsRow && tableBody) {
            noResultsRow = document.createElement('tr');
            noResultsRow.id = 'no-results-row';
            noResultsRow.innerHTML = `
                <td colspan="4" class="text-center py-5">
                    <div class="text-muted">
                        <i class="bi bi-search" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mt-3 mb-0">Nenhum arquivo ou pasta encontrado nesta pasta</p>
                    </div>
                </td>
            `;
            tableBody.appendChild(noResultsRow);
        }
    }

    function showGlobalNoResultsMessage(term) {
        let noResultsRow = document.getElementById('no-results-row');
        
        if (!noResultsRow && tableBody) {
            noResultsRow = document.createElement('tr');
            noResultsRow.id = 'no-results-row';
            noResultsRow.innerHTML = `
                <td colspan="4" class="text-center py-5">
                    <div class="text-muted">
                        <i class="bi bi-search" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mt-3 mb-0">Nenhum resultado para "<strong>${term}</strong>" em todo o repositório</p>
                        <small class="mt-2 d-block">Tente com outro termo de busca</small>
                    </div>
                </td>
            `;
            tableBody.appendChild(noResultsRow);
        }
    }

    function hideNoResultsMessage() {
        const noResultsRow = document.getElementById('no-results-row');
        if (noResultsRow) {
            noResultsRow.remove();
        }
    }

    // Inicializar contagem de resultados
    updateResultCount();
});
</script>
{% endblock %}
